<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>GSH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/GSH.png" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#111111" />
  <!-- Material Design 3 - Roboto Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/styles-tailwind.css" />
  <link rel="stylesheet" href="/css/variables.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <!-- Chart.js לגרפים -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body style="background:var(--bg); color:var(--text);">
  <!-- SPLASH SCREEN - FULL SCREEN (Material 3) -->
  <div id="splashScreen">
    <!-- Centered main content -->
    <div class="splash-center">
      <img src="/GSH.png" alt="GSH" class="w-24 h-24 mb-4 animate-pulse" style="width:96px; height:96px; margin-bottom:1rem;">
      <div class="splash-title">GSH</div>
      <div class="splash-subtitle">טוען את האפליקציה…</div>
    </div>
    
    <!-- Warpcodes brand at the bottom -->
    <div class="splash-footer">
      <img src="/WCdark.png" alt="Warpcodes" class="h-12 w-auto opacity-70" style="max-height:48px; height:48px; width:auto; opacity:0.7;">
      <div class="text-sm" style="color:var(--muted); opacity:0.6; font-weight:500; font-size:0.875rem;">Warpcodes</div>
    </div>
  </div>
  
  <!-- MAIN APP CONTENT (hidden until authenticated) -->
  <div id="appContent" class="hidden">
  <!-- HEADER - SynQ Style Two-Row Design -->
  <header class="shadow-sm" style="background:var(--card); border-bottom: 1px solid var(--border); position:sticky; top:0; z-index:30;">
    <!-- Row 1: User chathead, App name/logo, Household name, Invite button -->
    <div class="px-3 py-2 flex items-center justify-between gap-2" style="border-bottom: 1px solid var(--border);">
      <!-- Left: User chathead -->
      <button id="profileBtn" class="profile-button hidden rounded-full overflow-hidden transition-all flex items-center justify-center flex-shrink-0" style="width: 40px; height: 40px; border: 2px solid var(--border); background: transparent; padding: 0;" title="פרופיל משתמש" onclick="showProfileModal()">
        <img id="profileBtnImg" src="/GSH.png" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block;" onerror="this.src='/GSH.png'" />
      </button>
      
      <!-- Center: App name/logo + Household name (centered, editable) -->
      <div class="flex-1 flex items-center justify-center gap-2 min-w-0">
        <img src="/GSH.png" alt="GSH" class="w-8 h-8 flex-shrink-0" style="object-fit: contain;">
        <div class="text-lg font-bold truncate cursor-pointer select-none" style="color:var(--text); line-height:1.2;" id="householdNameText" ondblclick="showEditHouseholdNameModal()" title="לחץ פעמיים לעריכה">GSH</div>
      </div>
      
      <!-- Right: Invite button + Theme toggle -->
      <div class="flex items-center gap-1 flex-shrink-0">
        <button id="inviteCodeBtn" class="text-lg px-2 py-1 rounded-lg transition-colors hidden" style="color:var(--text); min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" title="צור קוד הזמנה" onclick="showInviteCodeModal()">
          <span>🔗</span>
        </button>
        <button id="themeToggle" class="text-lg px-2 py-1 rounded-lg transition-colors flex-shrink-0" style="color:var(--text); min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" title="החלף מצב תצוגה">
          <span id="themeIcon">🌙</span>
        </button>
      </div>
    </div>
    
    <!-- Row 2: 4 Navigation Tabs -->
    <div class="nav-tabs-container" style="border-top: 1px solid var(--border); display: flex; position: relative;">
      <button id="navShopping" class="nav-tab active flex flex-col items-center justify-center gap-1 flex-1" style="min-width: 0;" aria-label="רשימת קניות" role="tab" aria-selected="true">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <span class="text-xs truncate w-full text-center">קניות</span>
      </button>
      <button id="navTasks" class="nav-tab flex flex-col items-center justify-center gap-1 flex-1" style="min-width: 0;" aria-label="רשימת משימות" role="tab" aria-selected="false">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
        <span class="text-xs truncate w-full text-center">משימות</span>
      </button>
      <button id="navNotes" class="nav-tab flex flex-col items-center justify-center gap-1 flex-1" style="min-width: 0;" aria-label="רשימת פתקים" role="tab" aria-selected="false">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
        <span class="text-xs truncate w-full text-center">פתקים</span>
      </button>
      <button id="navReminders" class="nav-tab flex flex-col items-center justify-center gap-1 flex-1" style="min-width: 0;" aria-label="רשימת תזכורות" role="tab" aria-selected="false">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span class="text-xs truncate w-full text-center">תזכורות</span>
      </button>
    </div>
  </header>

  <!-- Unified App Bar (Material 3) -->
  <header id="appBar" class="app-bar">
    <div class="w-full max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-3 py-3 flex flex-col gap-3">
      <!-- Top row: title + version + actions -->
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="flex items-baseline gap-2 min-w-0">
          <div id="appBarTitle" class="font-semibold text-lg truncate" style="color:var(--text);">רשימת קניות</div>
          <span id="appVersion" class="text-xs" style="color:var(--muted);">v1.0.2</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <!-- Shopping actions -->
          <div id="appBarActionsShopping" class="flex items-center gap-2">
            <button id="templatesBtn" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">תבניות</button>
            <button id="importBtn" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">ייבוא רשימה</button>
          </div>
          <!-- Tasks actions -->
          <div id="appBarActionsTasks" class="flex items-center gap-2 hidden">
            <button id="tasksTabList" class="text-sm border rounded px-3 py-1.5" style="color:var(--bg); border-color:var(--accent); background:var(--accent);">רשימה</button>
            <button id="tasksTabGantt" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);">ציר זמן</button>
          </div>
          <!-- Notes actions -->
          <div id="appBarActionsNotes" class="flex items-center gap-2 hidden">
            <button id="notesViewToggle" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);">תצוגת רשימה</button>
            <button id="notesFilterBtn" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);">מסננים</button>
          </div>
          <!-- Reminders actions -->
          <div id="appBarActionsReminders" class="flex items-center gap-2 hidden">
            <button id="remindersFilterAll" class="text-sm border rounded px-3 py-1.5 active" style="color:var(--text); border-color:var(--border);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">הכל</button>
            <button id="remindersFilterActive" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">פעילות</button>
            <button id="remindersFilterDone" class="text-sm border rounded px-3 py-1.5" style="color:var(--text); border-color:var(--border);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">הושלמו</button>
          </div>
        </div>
      </div>
      <!-- Search row -->
      <div class="mt-1 relative">
        <input id="search" type="search" placeholder="חיפוש…" class="w-full rounded-lg border px-3 py-2 pr-9 focus:outline-none focus:ring" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);" aria-label="חיפוש">
        <button id="clearSearch" class="absolute left-2 top-1/2 -translate-y-1/2 text-xs hidden" style="color:var(--muted);" aria-label="נקה חיפוש">נקה</button>
      </div>
      <!-- Supporting text (used by shopping for open count) -->
      <div id="openCount" class="text-sm" style="color:var(--text);">—</div>
    </div>
  </header>

  <!-- MAIN: רשימת קניות -->
  <main id="mainView" class="w-full max-w-7xl mx-auto py-3" style="padding: 16px; padding-bottom: calc(var(--footer-h) + 20px);"></main>
  
  <!-- MAIN: Tasks View -->
  <main id="tasksView" class="w-full max-w-7xl mx-auto py-3 hidden" style="padding: 16px; padding-bottom: calc(var(--footer-h) + 20px);">
    <!-- Tasks List View -->
    <div id="tasksListView" class="flex flex-col gap-3">
      <div id="tasksList" class="flex flex-col gap-3 mb-4"></div>
    </div>
    
    <!-- Tasks Gantt View -->
    <div id="tasksGanttView" class="hidden">
      <!-- Gantt Controls (moved above timeline) -->
      <div class="flex flex-col gap-3 mb-3 mt-2">
        <!-- Date Range Display -->
        <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-lg" style="color:var(--text);">ציר זמן משימות</h3>
            <span id="ganttDateRange" class="text-sm" style="color:var(--muted);">טוען...</span>
        </div>
          <div class="text-xs" style="color:var(--muted);">קיצורי מקלדת: ← → (שבוע), ↑ ↓ (חודש), Home (היום), End (התאם לכל המשימות)</div>
        </div>
        <!-- Navigation Controls -->
        <div class="flex items-center gap-2 flex-wrap">
          <!-- Quick View Presets -->
          <div class="flex items-center gap-1 border rounded px-2 py-1" style="border-color:var(--border);">
            <button id="ganttViewToday" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="היום">היום</button>
            <button id="ganttViewWeek" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="השבוע">השבוע</button>
            <button id="ganttViewMonth" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="החודש">החודש</button>
            <button id="ganttViewYear" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="השנה">השנה</button>
            <button id="ganttFitAll" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="התאם לכל המשימות">התאם לכל</button>
          </div>
          <!-- Navigation Arrows -->
          <div class="flex items-center gap-1 border rounded px-2 py-1" style="border-color:var(--border);">
            <button id="ganttPrevMonth" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="חודש קודם">⇇</button>
            <button id="ganttPrev" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="שבוע קודם">←</button>
            <button id="ganttNext" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="שבוע הבא">→</button>
            <button id="ganttNextMonth" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="חודש הבא">⇉</button>
          </div>
          <!-- Zoom Controls -->
          <div class="flex items-center gap-1 border rounded px-2 py-1" style="border-color:var(--border);">
            <button id="ganttZoomOut" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="הקטן">−</button>
            <button id="ganttZoomIn" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="הגדל">+</button>
          </div>
          <!-- Task Navigation & Date Jump -->
          <div class="flex items-center gap-1 border rounded px-2 py-1" style="border-color:var(--border);">
            <button id="ganttPrevTask" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="משימה קודמת">◄ משימה</button>
            <button id="ganttNextTask" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="משימה הבאה">משימה ►</button>
            <button id="ganttJumpTo" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="קפוץ לתאריך">📅</button>
          </div>
          <!-- Direction Toggle -->
          <div class="flex items-center gap-1 border rounded px-2 py-1" style="border-color:var(--border);">
            <button id="ganttDirectionToggle" class="text-xs px-2 py-1 rounded" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'" title="החלף כיוון ציר זמן">⇄ כיוון</button>
          </div>
        </div>
      </div>
      <!-- Gantt Timeline Container (full-width) -->
      <div id="ganttContainer" class="gantt-container" style="min-height:400px; transition: opacity 0.3s ease;">
        <div id="ganttTimeline" class="gantt-timeline"></div>
      </div>
      <!-- Gantt Legend -->
      <div id="ganttLegend" class="mt-3 pt-3 border-t flex flex-wrap gap-3 text-xs" style="border-color:var(--border); color:var(--muted);">
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#ef4444;"></div>
          <span>חריג</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#f97316;"></div>
          <span>0-3 ימים</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#fbbf24;"></div>
          <span>שבוע</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#84cc16;"></div>
          <span>שבועיים</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#3b82f6;"></div>
          <span>עתידי</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#10b981;"></div>
          <span>הושלם</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-3 h-3 rounded" style="background:#6b7280;"></div>
          <span>בוטל/ללא תאריך</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Notes Filters (moved out of app bar; toggled by notes actions) -->
  <div id="notesFilters" class="hidden mt-2 p-3 border rounded max-w-5xl mx-auto" style="background:var(--card); border-color:var(--border);">
    <div class="flex flex-wrap gap-3 items-center text-sm">
      <label class="flex items-center gap-2">
        <input type="checkbox" id="filterPinned" class="w-4 h-4">
        <span>מוצמדות בלבד</span>
      </label>
      <label class="flex items-center gap-2">
        <input type="checkbox" id="filterArchived" class="w-4 h-4">
        <span>בארכיון</span>
      </label>
      <label class="flex items-center gap-2">
        <input type="checkbox" id="filterTrash" class="w-4 h-4">
        <span>בסל המחזור</span>
      </label>
    </div>
  </div>

  <!-- MAIN: Notes View -->
  <main id="notesView" class="w-full max-w-7xl mx-auto py-3 hidden" style="padding: 16px; padding-bottom: calc(64px + env(safe-area-inset-bottom, 0px) + 20px);">
    <!-- Notes Grid/List -->
    <div id="notesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    <!-- Notes Categories Bar -->
    <nav class="fixed-footer" id="notesCategoriesNav" style="display: none;">
      <div class="max-w-5xl mx-auto h-full">
        <div class="h-full overflow-x-auto no-scrollbar">
          <div id="notesCategoriesList" class="h-full flex gap-3 items-center justify-center min-w-max px-2"></div>
        </div>
      </div>
    </nav>
  </main>

  <!-- Reminders Header removed: actions now live in unified app bar -->

  <!-- MAIN: Reminders View -->
  <main id="remindersView" class="w-full max-w-7xl mx-auto py-3 hidden" style="padding: 16px; padding-bottom: calc(var(--footer-h) + 20px);">
    <!-- Reminders List -->
    <div id="remindersContainer" class="flex flex-col gap-3">
      <div class="text-sm" style="color:var(--muted);">טוען תזכורות...</div>
    </div>
  </main>

  <!-- Floating Action Buttons (FABs) -->
  <button id="fabShopping" class="fab hidden" aria-label="הוסף פריט">
    <span class="fab-icon">+</span>
  </button>
  <button id="fabTasks" class="fab hidden" aria-label="הוסף משימה">
    <span class="fab-icon">+</span>
  </button>
  <button id="fabNotes" class="fab hidden" aria-label="הוסף פתק">
    <span class="fab-icon">+</span>
  </button>
  <button id="fabReminders" class="fab hidden" aria-label="הוסף תזכורת">
    <span class="fab-icon">+</span>
  </button>

  <!-- Category Bars - At root level for proper fixed positioning -->
  <!-- Shopping Categories Bar -->
  <nav class="fixed-footer" id="shoppingCategoriesNav" style="display: none;">
    <div class="max-w-5xl mx-auto h-full">
      <div class="h-full overflow-x-auto no-scrollbar">
        <div id="shoppingCategoriesList" class="h-full flex gap-3 items-center justify-center min-w-max px-2"></div>
      </div>
    </div>
  </nav>

  <!-- Tasks Categories Bar -->
  <nav class="fixed-footer" id="tasksCategoriesNav" style="display: none;">
    <div class="max-w-5xl mx-auto h-full">
      <div class="h-full overflow-x-auto no-scrollbar">
        <div id="tasksCategoriesList" class="h-full flex gap-3 items-center justify-center min-w-max px-2"></div>
      </div>
    </div>
  </nav>

  <!-- Notes Categories Bar -->
  <nav class="fixed-footer" id="notesCategoriesNav" style="display: none;">
    <div class="max-w-5xl mx-auto h-full">
      <div class="h-full overflow-x-auto no-scrollbar">
        <div id="notesCategoriesList" class="h-full flex gap-3 items-center justify-center min-w-max px-2"></div>
      </div>
    </div>
  </nav>

  <!-- Reminders Categories Bar -->
  <nav class="fixed-footer" id="remindersCategoriesNav" style="display: none;">
    <div class="max-w-5xl mx-auto h-full">
      <div class="h-full overflow-x-auto no-scrollbar">
        <div id="remindersCategoriesList" class="h-full flex gap-3 items-center justify-center min-w-max px-2"></div>
      </div>
    </div>
  </nav>

  <!-- MAIN: אנליטיקות עם גרפים + אקורדיון יומי -->
  <main id="analyticsView" class="w-full max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-3 py-3 hidden">
    <div class="flex gap-2 mb-3 flex-wrap">
      <button id="tabDay"   class="px-3 py-1.5 rounded-full border bg-black text-white">לפי יום</button>
      <button id="tabWeek"  class="px-3 py-1.5 rounded-full border">לפי שבוע (30 יום)</button>
      <button id="tabMonth" class="px-3 py-1.5 rounded-full border">לפי חודש</button>
      <button id="tabItem"  class="px-3 py-1.5 rounded-full border">לפי פריט (Top 10)</button>
    </div>
    <div id="analyticsSummary" class="grid gap-3 mb-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="summary-card border rounded-xl bg-white p-3 flex flex-col gap-1">
        <div class="text-xs" style="color:var(--muted);">פריטים פתוחים</div>
        <div id="summaryOpen" class="text-2xl font-semibold">0</div>
      </div>
      <div class="summary-card border rounded-xl bg-white p-3 flex flex-col gap-1">
        <div class="text-xs" style="color:var(--muted);">פריטים דחופים</div>
        <div id="summaryUrgent" class="text-2xl font-semibold">0</div>
      </div>
      <div class="summary-card border rounded-xl bg-white p-3 flex flex-col gap-1">
        <div class="text-xs" style="color:var(--muted);">הוצאות 7 ימים</div>
        <div id="summaryWeek" class="text-2xl font-semibold">₪0.00</div>
      </div>
      <div class="summary-card border rounded-xl bg-white p-3 flex flex-col gap-1">
        <div class="text-xs" style="color:var(--muted);">הוצאות החודש</div>
        <div id="summaryMonth" class="text-2xl font-semibold">₪0.00</div>
      </div>
    </div>

    <section id="secDay" class="bg-white border rounded-xl p-3">
      <div class="chart-wrap"><canvas id="chartDay"></canvas></div>
      <!-- רשימת ימים עם אקורדיון -->
      <div id="dayAccordion" class="mt-4 space-y-2"></div>
    </section>

    <section id="secWeek"  class="bg-white border rounded-xl p-3 hidden">
      <div class="chart-wrap"><canvas id="chartWeek"></canvas></div>
    </section>

    <section id="secMonth" class="bg-white border rounded-xl p-3 hidden">
      <div class="chart-wrap"><canvas id="chartMonth"></canvas></div>
    </section>

    <section id="secItem"  class="bg-white border rounded-xl p-3 hidden">
      <div class="chart-wrap"><canvas id="chartItem"></canvas></div>
    </section>

    <section class="bg-white border rounded-xl p-3 mt-4">
      <div class="font-semibold mb-2">ווידג'ט למסך הבית</div>
      <p class="text-sm mb-2" style="color:var(--text);">הוסיפו את האפליקציה למסך הבית לקבלת גישה מהירה למצבי הקניות ולהודעות דחופות.</p>
      <ol class="list-decimal text-sm pl-5 space-y-1" style="color:var(--text);">
        <li>פתחו את האפליקציה בדפדפן Chrome</li>
        <li>לחצו על ⋮ ובחרו <strong>הוסף למסך הבית</strong></li>
        <li>לאשר ולהצמיד למקום הנוח ביותר</li>
      </ol>
      <div class="text-xs mt-2" style="color:var(--muted);">ווידג'ט עם ספירת הפריטים הדחופים יתווסף בעדכון הבא.</div>
    </section>
  </main>
  </div>
  <!-- END MAIN APP CONTENT -->

  <!-- --- מודלים (קטגוריה / פריט) נשארו כמו בגרסה היציבה --- -->
  <!-- MODALS MUST BE OUTSIDE appContent TO RENDER WHEN appContent IS HIDDEN -->
  <!-- Login/Auth Modal -->
  <div id="authModal" class="fixed inset-0 modal" style="display: none; z-index: 99999 !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important;">
    <div class="absolute inset-0 bg-black/80" data-close="false"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-6 text-center">
          <img src="/GSH.png" alt="GSH" class="w-20 h-20 mx-auto mb-4">
          <h2 class="text-2xl font-bold mb-2">ברוכים הבאים ל-GSH</h2>
          <p class="text-sm mb-6" style="color:var(--muted);">התחברו עם Google כדי להתחיל</p>
          <button id="googleSignInBtn" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg font-semibold transition-all" style="background:#4285f4; color:#ffffff; border:1px solid #4285f4;">
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>התחבר עם Google</span>
          </button>
          <div id="authLoading" class="hidden mt-4">
            <div class="text-sm" style="color:var(--muted);">מתחבר...</div>
          </div>
          <div id="authError" class="hidden mt-4 text-sm" style="color:#ef4444;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding Modal -->
  <div id="onboardingModal" class="fixed inset-0 z-[100] modal">
    <div class="absolute inset-0 bg-black/80" data-close="false"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl my-8" style="background:var(--card); color:var(--text);">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-2 text-center">בואו נכיר אותך</h2>
          <p class="text-sm mb-6 text-center" style="color:var(--muted);">נא להשלים את הפרטים הבאים</p>
          
          <div class="space-y-4">
            <div class="text-center mb-4">
              <img id="onboardingProfileImg" src="/GSH.png" alt="Profile" class="w-24 h-24 rounded-full mx-auto border-2 object-cover" style="border-color:var(--border);">
              <button id="onboardingChangePhoto" class="mt-2 text-sm px-3 py-1 rounded border" style="color:var(--text); border-color:var(--border);">שנה תמונה</button>
              <input id="onboardingPhotoFile" type="file" accept="image/*" class="hidden">
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm block mb-1">שם פרטי</label>
                <input id="onboardingFirstName" type="text" placeholder="שם פרטי" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
              </div>
              <div>
                <label class="text-sm block mb-1">שם משפחה</label>
                <input id="onboardingLastName" type="text" placeholder="שם משפחה" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
              </div>
            </div>
            
            <div>
              <label class="text-sm block mb-1">כינוי (אופציונלי)</label>
              <input id="onboardingNickname" type="text" placeholder="כיצד תרצה שיפנו אליך?" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
            
            <div id="onboardingError" class="hidden text-sm p-2 rounded" style="background:#fee2e2; color:#991b1b;"></div>
            
            <div class="pt-4 flex gap-3">
              <button id="onboardingSkip" class="flex-1 px-4 py-2 rounded-lg border" style="color:var(--text); border-color:var(--border);">דלג</button>
              <button id="onboardingSave" class="flex-1 px-4 py-2 rounded-lg font-semibold" style="background:var(--accent); color:var(--bg);">שמור והמשך</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite Code Modal -->
  <div id="inviteCodeModal" class="fixed inset-0 z-[100] modal">
    <div class="absolute inset-0 bg-black/80" data-close="false"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl my-8" style="background:var(--card); color:var(--text);">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-2 text-center">קוד הזמנה למשק הבית</h2>
          <p class="text-sm mb-6 text-center" style="color:var(--muted);">שתף קוד זה עם חברי משפחה כדי שיוכלו להצטרף</p>
          
          <div id="inviteCodeDisplay" class="text-center space-y-4">
            <div class="p-6 rounded-lg border-2" style="border-color:var(--accent); background:var(--input-bg);">
              <div class="text-4xl font-mono tracking-[0.5em] font-bold mb-2" style="color:var(--accent);" id="inviteCodeValue">----</div>
              <div class="text-xs" style="color:var(--muted);">תוקף: 7 ימים</div>
            </div>
            
            <button id="inviteCodeCopyBtn" class="w-full px-4 py-3 rounded-lg font-semibold border" style="background:var(--accent); color:var(--bg); border-color:var(--accent);" onclick="copyInviteCode()">
              העתק קוד
            </button>
            
            <button id="inviteCodeGenerateBtn" class="w-full px-4 py-2 rounded-lg border" style="color:var(--text); border-color:var(--border);" onclick="generateNewInviteCode()">
              צור קוד חדש
            </button>
          </div>
          
          <!-- Members Section -->
          <div class="mt-6 pt-6" style="border-top: 1px solid var(--border);">
            <h3 class="text-lg font-semibold mb-3 text-center">חברי משק הבית</h3>
            <div id="householdMembersList" class="space-y-2 max-h-60 overflow-y-auto">
              <!-- Members will be populated here -->
            </div>
          </div>
          
          <div id="inviteCodeError" class="hidden mt-4 text-sm p-2 rounded" style="background:#fee2e2; color:#991b1b;"></div>
          
          <div class="mt-4 text-center">
            <button onclick="document.getElementById('inviteCodeModal').classList.remove('show')" class="text-sm" style="color:var(--muted);">סגור</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Household Name Modal -->
  <div id="editHouseholdNameModal" class="fixed inset-0 z-[100] modal">
    <div class="absolute inset-0 bg-black/80" data-close="false" onclick="document.getElementById('editHouseholdNameModal').classList.remove('show')"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4 text-center">ערוך שם משק הבית</h2>
          <input id="editHouseholdNameInput" type="text" placeholder="שם משק הבית" class="w-full border rounded px-3 py-2 mb-4" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
          <div id="editHouseholdNameError" class="hidden mb-4 text-sm p-2 rounded" style="background:#fee2e2; color:#991b1b;"></div>
          <div class="flex gap-3">
            <button onclick="document.getElementById('editHouseholdNameModal').classList.remove('show')" class="flex-1 px-4 py-2 rounded-lg border" style="color:var(--text); border-color:var(--border);">ביטול</button>
            <button onclick="saveHouseholdName()" class="flex-1 px-4 py-2 rounded-lg font-semibold" style="background:var(--accent); color:var(--bg);">שמור</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="profileModal" class="fixed inset-0 z-[100] modal">
    <div class="absolute inset-0 bg-black/80" data-close="false"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl my-8" style="background:var(--card); color:var(--text);">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-6 text-center">פרופיל משתמש</h2>
          
          <!-- Profile Image -->
          <div class="flex flex-col items-center mb-6">
            <div class="relative">
              <img id="profileModalImg" src="/GSH.png" alt="Profile" class="w-24 h-24 rounded-full border-2 object-cover mx-auto" style="border-color:var(--accent);">
              <label class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 cursor-pointer hover:bg-blue-600 transition-colors" title="שנה תמונה">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
                <input id="profileImageFile" type="file" accept="image/*" class="hidden">
              </label>
            </div>
            <button id="profileRemoveImage" class="text-sm mt-2" style="color:var(--muted);">הסר תמונה</button>
          </div>
          
          <!-- Profile Fields -->
          <div class="space-y-4">
            <div>
              <label class="text-sm block mb-1">שם פרטי *</label>
              <input id="profileFirstName" type="text" placeholder="הזן שם פרטי" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
            
            <div>
              <label class="text-sm block mb-1">שם משפחה *</label>
              <input id="profileLastName" type="text" placeholder="הזן שם משפחה" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
            
            <div>
              <label class="text-sm block mb-1">כינוי (אופציונלי)</label>
              <input id="profileNickname" type="text" placeholder="הזן כינוי" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
          </div>
          
          <div id="profileError" class="hidden mt-4 text-sm p-2 rounded" style="background:#fee2e2; color:#991b1b;"></div>
          
          <div class="mt-6 flex gap-3">
            <button id="profileSaveBtn" class="flex-1 px-4 py-3 rounded-lg font-semibold border" style="background:var(--accent); color:var(--bg); border-color:var(--accent);">שמור</button>
            <button id="profileCancelBtn" class="px-4 py-3 rounded-lg border" style="color:var(--text); border-color:var(--border);">ביטול</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Household Creation/Join Modal -->
  <div id="householdModal" class="fixed inset-0 z-[100] modal">
    <div class="absolute inset-0 bg-black/80" data-close="false"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl my-8" style="background:var(--card); color:var(--text);">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-2 text-center">ברוכים הבאים ל-GSH</h2>
          <p class="text-sm mb-6 text-center" style="color:var(--muted);">צרו משק בית חדש או הצטרפו למשק בית קיים</p>
          
          <div id="householdCreateView" class="space-y-4">
            <div>
              <label class="text-sm block mb-1">שם משק הבית</label>
              <input id="householdNameInput" type="text" placeholder="לדוגמה: משפחת כהן" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
            
            <div class="pt-2">
              <button id="householdCreateBtn" class="w-full px-4 py-3 rounded-lg font-semibold" style="background:var(--accent); color:var(--bg);">צור משק בית</button>
            </div>
            
            <div class="text-center">
              <button id="householdShowJoin" class="text-sm" style="color:var(--accent);">או הצטרף למשק בית קיים</button>
            </div>
          </div>
          
          <div id="householdJoinView" class="space-y-4 hidden">
            <div>
              <label class="text-sm block mb-1">קוד הזמנה (4 ספרות)</label>
              <input id="householdInviteCode" type="text" placeholder="0000" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" class="w-full border rounded px-3 py-2 text-center text-2xl tracking-[0.5em] font-mono" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
            
            <div class="pt-2">
              <button id="householdJoinBtn" class="w-full px-4 py-3 rounded-lg font-semibold" style="background:var(--accent); color:var(--bg);">הצטרף למשק בית</button>
            </div>
            
            <div class="text-center">
              <button id="householdShowCreate" class="text-sm" style="color:var(--accent);">או צור משק בית חדש</button>
            </div>
          </div>
          
          <div id="householdError" class="hidden mt-4 text-sm p-2 rounded" style="background:#fee2e2; color:#991b1b;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: קטגוריה -->
  <div id="catModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-md rounded-xl overflow-hidden shadow-2xl">
        <div class="p-3 border-b flex items-center justify-between">
          <div class="font-semibold" id="catModalTitle">קטגוריה</div>
          <button class="text-sm px-2 py-1 rounded border" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="catId">
          <div>
            <label class="text-sm">שם קטגוריה</label>
            <input id="catName" type="text" placeholder="לדוגמה: מוצרי חלב" class="w-full border rounded px-2 py-2">
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input id="catPinned" type="checkbox" class="w-4 h-4">
            <span>הצג קטגוריה זו ראשונה (מועדפת)</span>
          </label>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="catPreview" src="/cat.png" class="w-12 h-12 rounded-full border object-cover">
              <label class="px-3 py-2 border rounded cursor-pointer">
                בחר תמונה
                <input id="catFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="catFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div class="pt-2 flex gap-2">
            <button id="catSave" class="flex-1 bg-black text-white rounded-lg py-2">שמור</button>
            <button id="catDelete" class="px-3 py-2 rounded-lg border hidden">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: קטגוריית משימות -->
  <div id="taskCatModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-3 border-b flex items-center justify-between" style="border-color:var(--border);">
          <div class="font-semibold" id="taskCatModalTitle">קטגוריית משימות</div>
          <button class="text-sm px-2 py-1 rounded border" style="color:var(--text); border-color:var(--border);" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="taskCatId">
          <div>
            <label class="text-sm">שם קטגוריה</label>
            <input id="taskCatName" type="text" placeholder="לדוגמה: עבודה" class="w-full border rounded px-2 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input id="taskCatPinned" type="checkbox" class="w-4 h-4">
            <span>הצג קטגוריה זו ראשונה (מועדפת)</span>
          </label>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="taskCatPreview" src="/cat.png" class="w-12 h-12 rounded-full border object-cover" style="border-color:var(--border);">
              <label class="px-3 py-2 border rounded cursor-pointer" style="color:var(--text); border-color:var(--border);">
                בחר תמונה
                <input id="taskCatFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="taskCatFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div>
            <label class="text-sm block mb-1">צבע (אם אין תמונה)</label>
            <div class="flex gap-2 flex-wrap">
              <button class="color-option w-8 h-8 rounded-full border-2" data-color="#3b82f6" style="width:32px;height:32px;border-radius:50%;background:#3b82f6 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;" title="כחול"></button>
              <button class="color-option w-8 h-8 rounded-full border-2" data-color="#10b981" style="width:32px;height:32px;border-radius:50%;background:#10b981 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;" title="ירוק"></button>
              <button class="color-option w-8 h-8 rounded-full border-2" data-color="#f59e0b" style="width:32px;height:32px;border-radius:50%;background:#f59e0b !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;" title="כתום"></button>
              <button class="color-option w-8 h-8 rounded-full border-2" data-color="#ef4444" style="width:32px;height:32px;border-radius:50%;background:#ef4444 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;" title="אדום"></button>
              <button class="color-option w-8 h-8 rounded-full border-2" data-color="#8b5cf6" style="width:32px;height:32px;border-radius:50%;background:#8b5cf6 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;" title="סגול"></button>
              <button class="color-option w-8 h-8 rounded-full border-2" data-color="#ec4899" style="width:32px;height:32px;border-radius:50%;background:#ec4899 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;" title="ורוד"></button>
            </div>
            <input type="hidden" id="taskCatColor" value="#3b82f6">
          </div>
          <div class="pt-2 flex gap-2">
            <button id="taskCatSave" class="flex-1 bg-black text-white rounded-lg py-2">שמור</button>
            <button id="taskCatDelete" class="px-3 py-2 rounded-lg border hidden" style="color:var(--text); border-color:var(--border);">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: הוספת פריט מהירה -->
  <div id="quickAddModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-md rounded-xl overflow-hidden shadow-2xl">
        <div class="p-3 border-b flex items-center justify-between">
          <div class="font-semibold">הוספת פריט</div>
          <button class="text-sm px-2 py-1 rounded border" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <div>
            <label class="text-sm">שם פריט</label>
            <input id="qaName" type="text" placeholder="לדוגמה: חלב 3%" class="w-full border rounded px-2 py-2">
          </div>
          <div>
            <label class="text-sm">קטגוריה</label>
            <select id="qaCategory" class="w-full border rounded px-2 py-2"></select>
          </div>
          <div>
            <label class="text-sm">תיאור</label>
            <input id="qaDesc" type="text" placeholder="מותג, משקל, הערות" class="w-full border rounded px-2 py-2">
          </div>
          <div>
            <label class="text-sm">הערות נוספות</label>
            <textarea id="qaNote" rows="2" placeholder="מידע שחשוב לזכור..." class="w-full border rounded px-2 py-2"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm">כמות</label>
              <input id="qaQty" type="number" placeholder="כמות (למשל 1)" class="w-full border rounded px-2 py-2">
            </div>
            <div>
              <label class="text-sm">מחיר ליחידה (₪)</label>
              <input id="qaPrice" type="number" step="0.01" placeholder="מחיר ליחידה" class="w-full border rounded px-2 py-2">
            </div>
          </div>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <label class="px-3 py-2 border rounded cursor-pointer">
                בחר תמונה
                <input id="qaFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="qaFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div class="pt-2">
            <button id="qaSave" class="w-full bg-black text-white rounded-lg py-2">שמור</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: ייבוא רשימה -->
  <div id="importModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-2xl rounded-xl overflow-hidden shadow-2xl">
        <div class="p-3 border-b flex items-center justify-between">
          <div class="font-semibold">ייבוא רשימה מהעתקה</div>
          <button class="text-sm px-2 py-1 rounded border" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-4">
          <p class="text-sm" style="color:var(--text);">
            העתיקו את הרשימה מ-Google Keep/Notes והדביקו כאן. כל שורה תזוהה כפריט. אפשר לציין כמות עם
            <code class="bg-gray-100 px-1 rounded text-xs">x3</code> או <code class="bg-gray-100 px-1 rounded text-xs">×3</code>.
          </p>

          <div class="space-y-2">
            <label class="text-sm font-medium block">קטגוריה</label>
            <select id="importCategory" class="w-full border rounded px-3 py-2"></select>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium block">הדבק רשימה</label>
            <textarea id="importText" rows="6" class="w-full border rounded px-3 py-2" placeholder="• עגבניות x2
• לחם - פרוס
• חלב 3% ×3
"></textarea>
          </div>

          <div id="importErrors" class="text-sm text-red-600 hidden"></div>

          <div class="border rounded-lg p-3 bg-gray-50">
            <div class="flex items-center justify-between mb-2 text-sm">
              <div>תצוגה מקדימה</div>
              <div id="importCount" class="font-semibold" style="color:var(--text);">0 פריטים</div>
            </div>
            <div id="importPreview" class="max-h-48 overflow-y-auto text-sm space-y-1" style="color:var(--text);">
              <div style="color:var(--muted);">אין פריטים עדיין.</div>
            </div>
          </div>

          <div class="flex justify-end gap-2 pt-2">
            <button class="px-3 py-2 rounded border" data-close>ביטול</button>
            <button id="importAddBtn" class="px-4 py-2 rounded bg-black text-white disabled:opacity-50" disabled>הוספת פריטים</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: עריכת פריט -->
  <div id="itemEditModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-md rounded-xl overflow-hidden shadow-2xl">
        <div class="p-3 border-b flex items-center justify-between">
          <div class="font-semibold">עריכת פריט</div>
          <button class="text-sm px-2 py-1 rounded border" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="ieId">
          <div>
            <label class="text-sm">שם</label>
            <input id="ieName" type="text" class="w-full border rounded px-2 py-2">
          </div>
          <div>
            <label class="text-sm">תיאור</label>
            <input id="ieDesc" type="text" class="w-full border rounded px-2 py-2">
          </div>
          <div>
            <label class="text-sm">הערות</label>
            <textarea id="ieNote" rows="2" class="w-full border rounded px-2 py-2"></textarea>
          </div>
          <div>
            <label class="text-sm">קטגוריה</label>
            <select id="ieCategory" class="w-full border rounded px-2 py-2"></select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm">כמות</label>
              <input id="ieQty" type="number" class="w-full border rounded px-2 py-2">
            </div>
            <div>
              <label class="text-sm">מחיר ליחידה (₪)</label>
              <input id="iePrice" type="number" step="0.01" class="w-full border rounded px-2 py-2">
            </div>
          </div>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="iePreview" src="/buy.png" class="w-10 h-10 rounded-full border object-cover">
              <label class="px-3 py-2 border rounded cursor-pointer">
                בחר תמונה
                <input id="ieFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="ieFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div class="pt-2 flex gap-2">
            <button id="ieSave" class="flex-1 bg-black text-white rounded-lg py-2">שמור</button>
            <button id="ieDelete" class="px-3 py-2 rounded-lg border">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: תבניות -->
  <div id="templatesModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-3xl rounded-xl overflow-hidden shadow-2xl max-h-[90vh] flex flex-col">
        <div class="p-3 border-b flex items-center justify-between">
          <div class="font-semibold">תבניות מהירות</div>
          <button class="text-sm px-2 py-1 rounded border" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-4 overflow-y-auto">
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div class="text-sm" style="color:var(--text);">בחרו קטגוריה אליה יתווספו הפריטים</div>
            <select id="templateCategorySelect" class="border rounded px-3 py-2 min-w-[200px]"></select>
          </div>

          <section class="space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-semibold">התבניות שלי</div>
              <div class="text-xs" style="color:var(--muted);">מבוסס על הפריטים שבחרתם</div>
            </div>
            <div id="userTemplatesList" class="space-y-2"></div>

            <div class="border rounded-lg p-3 space-y-3" style="background:var(--card); color:var(--text); border-color:var(--border); opacity:0.9;">
              <div class="font-semibold text-sm">שמור תבנית חדשה</div>
              <div class="grid gap-3 md:grid-cols-[2fr,1fr]">
                <input id="templateNameInput" type="text" class="border rounded px-3 py-2" placeholder="שם התבנית (למשל ״קניות סופ״ש״)">
                <button id="templateSaveBtn" class="rounded bg-black text-white py-2 px-3 text-sm disabled:opacity-50">שמור מהקטגוריה הנוכחית</button>
              </div>
              <div class="text-xs" style="color:var(--muted);">התבנית תתבסס על כל הפריטים הפתוחים בקטגוריה שנמצאת כעת במוקד.</div>
            </div>
          </section>

          <section class="space-y-3">
            <div class="font-semibold">תבניות מוכנות</div>
            <div id="presetTemplatesList" class="space-y-2"></div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- מודל: עריכת משימה -->
  <div id="taskEditModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl max-h-[90vh] overflow-y-auto" style="background:var(--card); color:var(--text);">
        <div class="p-3 border-b flex items-center justify-between">
          <div class="font-semibold">עריכת משימה</div>
          <button class="text-sm px-2 py-1 rounded border" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="teId">
          <div>
            <label class="text-sm">שם משימה</label>
            <input id="teName" type="text" class="w-full border rounded px-2 py-2" placeholder="לדוגמה: פגישה עם לקוח">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm">תאריך התחלה (אופציונלי)</label>
              <input id="teStartDate" type="date" class="w-full border rounded px-2 py-2">
            </div>
            <div>
              <label class="text-sm">תאריך סיום (אופציונלי)</label>
              <input id="teEndDate" type="date" class="w-full border rounded px-2 py-2">
            </div>
          </div>
          <div>
            <label class="text-sm">אחריות</label>
            <div class="relative">
              <button id="teResponsibilityBtn" type="button" class="w-full border rounded px-2 py-2 text-right flex items-center justify-between gap-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
                <span id="teResponsibilityText">בחר</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <div id="teResponsibilityDropdown" class="hidden absolute z-50 w-full mt-1 border rounded shadow-lg max-h-60 overflow-y-auto" style="background:var(--card); border-color:var(--border);">
                <button type="button" class="w-full text-right px-3 py-2 hover:bg-gray-100 flex items-center gap-2" data-value="" style="color:var(--text);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">
                  <span>בחר</span>
                </button>
              </div>
              <input type="hidden" id="teResponsibility" value="">
            </div>
          </div>
          <div>
            <label class="text-sm">סטטוס</label>
            <select id="teStatus" class="w-full border rounded px-2 py-2">
              <option value="todo">לעשות</option>
              <option value="in_progress">בתהליך</option>
              <option value="finished">הושלם</option>
              <option value="canceled">בוטל</option>
            </select>
          </div>
          <div>
            <label class="text-sm">קטגוריה</label>
            <select id="teCategory" class="w-full border rounded px-2 py-2"></select>
          </div>
          <div>
            <label class="text-sm">פרטים נוספים</label>
            <textarea id="teDetails" rows="4" class="w-full border rounded px-2 py-2" placeholder="הערות, מספרי טלפון, כתובות אתרים..."></textarea>
            <div class="text-xs mt-1" style="color:var(--muted);">מספרי טלפון וכתובות אתרים יהיו לחיצים</div>
          </div>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="tePreview" src="" class="w-12 h-12 rounded border object-cover hidden" style="border-color:var(--border);">
              <label class="px-3 py-2 border rounded cursor-pointer" style="color:var(--text); border-color:var(--border);">
                בחר תמונה
                <input id="teFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="teFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div class="pt-2 flex gap-2">
            <button id="teSave" class="flex-1 bg-black text-white rounded-lg py-2">שמור</button>
            <button id="teDelete" class="px-3 py-2 rounded-lg border hidden font-medium" style="background:#ef4444 !important; color:#ffffff !important; border-color:#ef4444 !important;">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-[calc(var(--footer-h)+20px)] left-1/2 -translate-x-1/2 z-[1000] pointer-events-none text-sm px-3 py-2 rounded-lg shadow hidden" style="background:#000000 !important; color:#ffffff !important;"></div>
  
  <!-- Notes Editor Modal -->
  <div id="noteEditModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-2xl rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-3 border-b flex items-center justify-between" style="border-color:var(--border);">
          <div class="font-semibold">הערה</div>
          <button class="text-sm px-2 py-1 rounded border" data-close style="color:var(--text); border-color:var(--border);">סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="noteId">
          <div>
            <input id="noteTitle" type="text" placeholder="כותרת..." class="w-full border rounded px-3 py-2 text-lg font-semibold" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
          </div>
          <div>
            <textarea id="noteContent" rows="10" placeholder="קח הערה..." class="w-full border rounded px-3 py-2 resize-none" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);"></textarea>
          </div>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="notePreview" src="" class="w-12 h-12 rounded border object-cover hidden" style="border-color:var(--border);">
              <label class="px-3 py-2 border rounded cursor-pointer" style="color:var(--text); border-color:var(--border);">
                בחר תמונה
                <input id="noteFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="noteFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" id="notePinned" class="w-4 h-4">
              <span>הצמד</span>
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" id="noteArchived" class="w-4 h-4">
              <span>ארכיון</span>
            </label>
            <div class="flex items-center gap-2 text-sm">
              <span>תגיות:</span>
              <input id="noteLabels" type="text" placeholder="תגית1, תגית2..." class="flex-1 border rounded px-2 py-1" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
            </div>
            <div class="flex items-center gap-2 text-sm">
              <span>צבע:</span>
              <div class="flex gap-2 flex-wrap">
                <button type="button" class="note-color-option" data-color="#dbeafe" style="width:32px;height:32px;border-radius:50%;background-color:#dbeafe !important;background:#dbeafe !important;border:2px solid #3b82f6 !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="כחול בהיר"></button>
                <button type="button" class="note-color-option" data-color="#dcfce7" style="width:32px;height:32px;border-radius:50%;background-color:#dcfce7 !important;background:#dcfce7 !important;border:2px solid #10b981 !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="ירוק בהיר"></button>
                <button type="button" class="note-color-option" data-color="#fef3c7" style="width:32px;height:32px;border-radius:50%;background-color:#fef3c7 !important;background:#fef3c7 !important;border:2px solid #f59e0b !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="צהוב"></button>
                <button type="button" class="note-color-option" data-color="#fce7f3" style="width:32px;height:32px;border-radius:50%;background-color:#fce7f3 !important;background:#fce7f3 !important;border:2px solid #ec4899 !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="ורוד"></button>
                <button type="button" class="note-color-option" data-color="#e9d5ff" style="width:32px;height:32px;border-radius:50%;background-color:#e9d5ff !important;background:#e9d5ff !important;border:2px solid #8b5cf6 !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="סגול"></button>
                <button type="button" class="note-color-option" data-color="#fed7aa" style="width:32px;height:32px;border-radius:50%;background-color:#fed7aa !important;background:#fed7aa !important;border:2px solid #f97316 !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="כתום"></button>
                <button type="button" class="note-color-option" data-color="#fecaca" style="width:32px;height:32px;border-radius:50%;background-color:#fecaca !important;background:#fecaca !important;border:2px solid #ef4444 !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="אדום"></button>
                <button type="button" class="note-color-option" data-color="#f1f5f9" style="width:32px;height:32px;border-radius:50%;background-color:#f1f5f9 !important;background:#f1f5f9 !important;border:2px solid #64748b !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;" title="אפור"></button>
                <button type="button" class="note-color-option" data-color="#ffffff" style="width:32px;height:32px;border-radius:50%;background-color:#ffffff !important;background:#ffffff !important;border:2px solid #9ca3af !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;margin:0 !important;box-shadow:0 0 0 1px rgba(0,0,0,0.1) !important;" title="לבן"></button>
              </div>
              <input type="hidden" id="noteColor" value="#dbeafe">
            </div>
            <div class="flex items-center gap-2 text-sm">
              <span>קטגוריה:</span>
              <select id="noteCategory" class="flex-1 border rounded px-2 py-1" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);"></select>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="noteSave" class="flex-1 bg-black text-white rounded-lg py-2" style="background:var(--accent); color:var(--bg);">שמור</button>
            <button id="noteDelete" class="px-3 py-2 rounded-lg border hidden" style="color:var(--text); border-color:var(--border);">מחק</button>
            <button id="noteDeleteForever" class="px-3 py-2 rounded-lg border hidden bg-red-100" style="color:var(--text);">מחק לצמיתות</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Note Category Editor Modal -->
  <div id="noteCatModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-3 border-b flex items-center justify-between" style="border-color:var(--border);">
          <div class="font-semibold" id="noteCatModalTitle">קטגוריית פתקים</div>
          <button class="text-sm px-2 py-1 rounded border" style="color:var(--text); border-color:var(--border);" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="noteCatId">
          <div>
            <label class="text-sm">שם קטגוריה</label>
            <input id="noteCatName" type="text" placeholder="לדוגמה: עבודה" class="w-full border rounded px-2 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input id="noteCatPinned" type="checkbox" class="w-4 h-4">
            <span>הצג קטגוריה זו ראשונה (מועדפת)</span>
          </label>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="noteCatPreview" src="/cat.png" class="w-12 h-12 rounded-full border object-cover" style="border-color:var(--border);">
              <label class="px-3 py-2 border rounded cursor-pointer" style="color:var(--text); border-color:var(--border);">
                בחר תמונה
                <input id="noteCatFile" type="file" accept="image/*" class="hidden">
              </label>
            </div>
            <div id="noteCatFileName" class="text-xs mt-1" style="color:var(--muted);">לא נבחרה תמונה</div>
          </div>
          <div>
            <label class="text-sm block mb-1">צבע (אם אין תמונה)</label>
            <div class="flex gap-2 flex-wrap">
              <button class="color-option w-8 h-8 rounded border" data-color="#3b82f6" style="width:32px;height:32px;border-radius:8px;background:#3b82f6 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#ef4444" style="width:32px;height:32px;border-radius:8px;background:#ef4444 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#10b981" style="width:32px;height:32px;border-radius:8px;background:#10b981 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#f59e0b" style="width:32px;height:32px;border-radius:8px;background:#f59e0b !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#8b5cf6" style="width:32px;height:32px;border-radius:8px;background:#8b5cf6 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#ec4899" style="width:32px;height:32px;border-radius:8px;background:#ec4899 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
            </div>
            <input type="hidden" id="noteCatColor" value="#3b82f6">
          </div>
          <div class="pt-2 flex gap-2">
            <button id="noteCatSave" class="flex-1 bg-black text-white rounded-lg py-2" style="background:var(--accent); color:var(--bg);">שמור</button>
            <button id="noteCatDelete" class="px-3 py-2 rounded-lg border hidden font-medium" style="background:#ef4444 !important; color:#ffffff !important; border-color:#ef4444 !important;">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reminder Category Editor Modal -->
  <div id="reminderCatModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-3 border-b flex items-center justify-between" style="border-color:var(--border);">
          <div class="font-semibold" id="reminderCatModalTitle">קטגוריית תזכורות</div>
          <button class="text-sm px-2 py-1 rounded border" style="color:var(--text); border-color:var(--border);" data-close>סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="reminderCatId">
          <div>
            <label class="text-sm">שם קטגוריה</label>
            <input id="reminderCatName" type="text" placeholder="לדוגמה: עבודה" class="w-full border rounded px-2 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input id="reminderCatPinned" type="checkbox" class="w-4 h-4">
            <span>הצג קטגוריה זו ראשונה (מועדפת)</span>
          </label>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="reminderCatPreview" src="/cat.png" class="w-12 h-12 rounded-full border object-cover" style="border-color:var(--border);">
              <label class="px-3 py-2 border rounded cursor-pointer" style="color:var(--text); border-color:var(--border);">
                בחר תמונה
                <input id="reminderCatFile" type="file" accept="image/*" class="hidden">
              </label>
            </div>
            <div id="reminderCatFileName" class="text-xs mt-1" style="color:var(--muted);">לא נבחרה תמונה</div>
          </div>
          <div>
            <label class="text-sm block mb-1">צבע (אם אין תמונה)</label>
            <div class="flex gap-2 flex-wrap">
              <button class="color-option w-8 h-8 rounded border" data-color="#3b82f6" style="width:32px;height:32px;border-radius:8px;background:#3b82f6 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#ef4444" style="width:32px;height:32px;border-radius:8px;background:#ef4444 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#10b981" style="width:32px;height:32px;border-radius:8px;background:#10b981 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#f59e0b" style="width:32px;height:32px;border-radius:8px;background:#f59e0b !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#8b5cf6" style="width:32px;height:32px;border-radius:8px;background:#8b5cf6 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
              <button class="color-option w-8 h-8 rounded border" data-color="#ec4899" style="width:32px;height:32px;border-radius:8px;background:#ec4899 !important;border:2px solid var(--border) !important;cursor:pointer;display:inline-block !important;opacity:1 !important;visibility:visible !important;padding:0 !important;"></button>
            </div>
            <input type="hidden" id="reminderCatColor" value="#3b82f6">
          </div>
          <div class="pt-2 flex gap-2">
            <button id="reminderCatSave" class="flex-1 bg-black text-white rounded-lg py-2" style="background:var(--accent); color:var(--bg);">שמור</button>
            <button id="reminderCatDelete" class="px-3 py-2 rounded-lg border hidden font-medium" style="background:#ef4444 !important; color:#ffffff !important; border-color:#ef4444 !important;">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reminder Editor Modal -->
  <div id="reminderEditModal" class="fixed inset-0 z-[80] modal">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-md rounded-xl overflow-hidden shadow-2xl" style="background:var(--card); color:var(--text);">
        <div class="p-3 border-b flex items-center justify-between" style="border-color:var(--border);">
          <div class="font-semibold">תזכורת</div>
          <button class="text-sm px-2 py-1 rounded border" data-close style="color:var(--text); border-color:var(--border);">סגור</button>
        </div>
        <div class="p-4 space-y-3">
          <input type="hidden" id="reminderId">
          <div>
            <label class="text-sm">כותרת</label>
            <input id="reminderTitle" type="text" placeholder="תזכורת..." class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
          </div>
          <div id="reminderTimeSection">
            <label class="text-sm block mb-1">תאריך ושעה</label>
            <div class="flex flex-col gap-2">
              <input id="reminderTime" type="datetime-local" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
              <!-- Quick time presets -->
              <div class="flex flex-wrap gap-2">
                <button id="reminderNowBtn" class="text-xs px-3 py-1.5 rounded-full border" style="border-color:var(--border); color:var(--text); background:var(--md-sys-color-surface-variant);">עכשיו</button>
                <button id="reminderTomorrowBtn" class="text-xs px-3 py-1.5 rounded-full border" style="border-color:var(--border); color:var(--text); background:var(--md-sys-color-surface-variant);">מחר</button>
                <button id="reminderWeekBtn" class="text-xs px-3 py-1.5 rounded-full border" style="border-color:var(--border); color:var(--text); background:var(--md-sys-color-surface-variant);">שבוע קדימה</button>
              </div>
            </div>
          </div>
          <div>
            <label class="text-sm">קטגוריה</label>
            <select id="reminderCategory" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);"></select>
          </div>
          <div>
            <label class="text-sm">קשור להערה (אופציונלי)</label>
            <select id="reminderNoteId" class="w-full border rounded px-3 py-2" style="background:var(--input-bg); color:var(--input-text); border-color:var(--border);">
              <option value="">ללא הערה</option>
            </select>
          </div>
          <div>
            <label class="text-sm block mb-1">תמונה</label>
            <div class="flex items-center gap-2">
              <img id="reminderPreview" src="" class="w-12 h-12 rounded border object-cover hidden" style="border-color:var(--border);">
              <label class="px-3 py-2 border rounded cursor-pointer" style="color:var(--text); border-color:var(--border);">
                בחר תמונה
                <input id="reminderFile" type="file" accept="image/*" class="hidden">
              </label>
              <span id="reminderFileName" class="text-xs" style="color:var(--muted);">לא נבחרה תמונה</span>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="reminderSave" class="flex-1 bg-black text-white rounded-lg py-2" style="background:var(--accent); color:var(--bg);">שמור</button>
            <button id="reminderDelete" class="px-3 py-2 rounded-lg border hidden" style="color:var(--text); border-color:var(--border);">מחק</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-[2000] items-center justify-center hidden">
    <div class="bg-white rounded-lg p-4 flex flex-col items-center gap-2">
      <div class="w-8 h-8 border-4 border-gray-200 border-t-black rounded-full animate-spin"></div>
      <div class="text-sm" id="loadingText" style="color:var(--text);">טוען...</div>
    </div>
  </div>

  <!-- Firebase + לוגיקה -->
  <script type="module">
    // CRITICAL: Block ALL automatic reloads to prevent infinite loops
    // Set this flag immediately before any code can reload
    let GLOBAL_RELOAD_BLOCKED = false;
    
    // Helper function to safely reload (checks flag first)
    function safeReload(force) {
      if (GLOBAL_RELOAD_BLOCKED) {
        console.warn('[Reload] BLOCKED: All automatic reloads are disabled to prevent infinite loops. User can manually refresh if needed.');
        return;
      }
      window.location.reload(force);
    }
    
    import { initAuth, signInWithGoogle, signOutUser, completeOnboarding, createHousehold, joinHouseholdByCode, generateInviteCode, getCurrentUser, getCurrentUserProfile, getCurrentHousehold, waitForAuth, onAuthStateChange, updateUserProfile } from '/js/modules/auth.js';
    import { initShopping, drawItems, attachItemsListener, openQuickAdd } from '/js/modules/shopping.js';
    import { initTasks } from '/js/modules/tasks.js';
    import { initNotes } from '/js/modules/notes.js';
    import { initAnalytics } from '/js/modules/analytics.js';
    import { initReminders } from '/js/modules/reminders.js';
    import { initNotifications, getNotificationPermission } from '/js/utils/notifications.js';
    import { uploadFileAndGetURL } from '/js/utils/upload.js';
    import { toast, showLoading, hideLoading } from '/utils/helpers.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      initializeFirestore, persistentLocalCache,
      doc, setDoc, updateDoc, addDoc, deleteDoc,
      collection, query, where, orderBy, onSnapshot,
      serverTimestamp, limit, getDocs, getDoc, Timestamp,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    /* ---------------- CONFIG ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDW9cEbt6ltDpRGDrfv6RQtpVk4zc30aIY",
      authDomain: "gsh-shop-6cc4a.firebaseapp.com",
      projectId: "gsh-shop-6cc4a",
      storageBucket: "gsh-shop-6cc4a.firebasestorage.app",
      messagingSenderId: "114081496381",
      appId: "1:114081496381:web:391f552b1ee20757025954",
      measurementId: "G-N43W43M74H"
    };

    /* ---------------- INIT ---------------- */
    const app = initializeApp(firebaseConfig);
    const db  = initializeFirestore(app, { localCache: persistentLocalCache() });
    const storage = getStorage(app, "gs://gsh-shop-6cc4a.firebasestorage.app");

    /* ---------------- AUTHENTICATION INITIALIZATION ---------------- */
    let currentUserProfile = null;
    let currentHousehold = null;
    let authInitialized = false;

    // Get references to key elements
    const splashScreen = document.getElementById('splashScreen');
    const appContent = document.getElementById('appContent');
    
    // Ensure app content is hidden initially
    if (appContent) {
      appContent.classList.add('hidden');
    }
    
    // Define modal functions FIRST, before any auth initialization
    function showAuthModal() {
      console.log('showAuthModal called');
      const authModal = document.getElementById('authModal');
      if (!authModal) {
        console.error('Auth modal element not found!');
        // Fallback: show a basic login prompt
        document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg); color: var(--text); padding: 2rem;"><div style="text-align: center;"><h1>GSH</h1><p>טוען...</p></div></div>';
        return;
      }
      
      // CRITICAL: Move modal to body FIRST - ALWAYS, to ensure it can render
      // This ensures the modal can render even when appContent is hidden
      const currentParent = authModal.parentElement;
      const parentId = currentParent?.id || '';
      const parentDisplay = currentParent ? window.getComputedStyle(currentParent).display : '';
      
      // Always move if inside appContent OR if parent is hidden
      if (parentId === 'appContent' || parentDisplay === 'none' || !document.body.contains(authModal)) {
        console.log('Moving authModal to body - parent:', parentId, 'display:', parentDisplay);
        authModal.remove();
        document.body.appendChild(authModal);
      }
      
      // CRITICAL: Set body background FIRST before hiding splash
      document.body.style.background = 'var(--bg)';
      document.body.style.minHeight = '100vh';
      document.body.style.width = '100vw';
      document.documentElement.style.background = 'var(--bg)';
      document.documentElement.style.minHeight = '100vh';
      
      // Hide splash screen FIRST, then immediately show modal
      const splash = document.getElementById('splashScreen');
      if (splash) {
        // Remove splash from DOM flow but keep modal ready
        splash.style.transition = 'opacity 0.1s';
        splash.style.opacity = '0';
        setTimeout(() => {
          splash.classList.add('hidden');
          splash.style.display = 'none';
          splash.style.visibility = 'hidden';
          splash.style.pointerEvents = 'none';
          splash.style.zIndex = '-1';
        }, 100);
      }
      
      // Ensure app content is hidden
      hideApp();
      
      // Force show the auth modal IMMEDIATELY - no delays
      authModal.classList.remove('hidden');
      authModal.classList.add('show');
      
      // Use style property instead of setAttribute for immediate effect
      authModal.style.display = 'block';
      authModal.style.visibility = 'visible';
      authModal.style.opacity = '1';
      authModal.style.pointerEvents = 'auto';
      authModal.style.zIndex = '99999';
      authModal.style.position = 'fixed';
      authModal.style.top = '0';
      authModal.style.left = '0';
      authModal.style.right = '0';
      authModal.style.bottom = '0';
      authModal.style.width = '100vw';
      authModal.style.height = '100vh';
      authModal.style.margin = '0';
      authModal.style.padding = '0';
      authModal.style.background = 'transparent';
      
      // Force body and html settings
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
      
      // Ensure modal children are visible
      const overlay = authModal.querySelector('.bg-black\\/80') || authModal.children[0];
      const contentWrapper = authModal.querySelector('.flex.items-center') || authModal.children[1];
      const card = authModal.querySelector('.rounded-xl') || (contentWrapper ? contentWrapper.children[0] : null);
      
      if (overlay) {
        overlay.style.display = 'block';
        overlay.style.visibility = 'visible';
        overlay.style.opacity = '1';
        overlay.style.position = 'absolute';
        overlay.style.inset = '0';
        overlay.style.background = 'rgba(0, 0, 0, 0.8)';
        overlay.style.zIndex = '1';
      }
      
      if (contentWrapper) {
        contentWrapper.style.display = 'flex';
        contentWrapper.style.visibility = 'visible';
        contentWrapper.style.opacity = '1';
        contentWrapper.style.position = 'absolute';
        contentWrapper.style.inset = '0';
        contentWrapper.style.alignItems = 'center';
        contentWrapper.style.justifyContent = 'center';
        contentWrapper.style.padding = '1rem';
        contentWrapper.style.zIndex = '2';
      }
      
      if (card) {
        const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card').trim() || '#ffffff';
        card.style.display = 'block';
        card.style.visibility = 'visible';
        card.style.opacity = '1';
        card.style.background = cardBg;
        card.style.color = 'var(--text)';
        card.style.zIndex = '3';
        card.style.position = 'relative';
      }
      
      // Verify visibility after a moment
      requestAnimationFrame(() => {
        const rect = authModal.getBoundingClientRect();
        const computed = window.getComputedStyle(authModal);
        if (rect.width === 0 || rect.height === 0 || computed.display === 'none') {
          console.warn('Modal not visible, forcing display');
          authModal.style.cssText += 'display: block !important; visibility: visible !important; opacity: 1 !important;';
        }
      });
    }

    function hideAuthModal() {
      const authModal = document.getElementById('authModal');
      if (authModal) {
        authModal.classList.remove('show');
        authModal.classList.add('hidden');
        authModal.style.display = 'none';
        authModal.style.visibility = 'hidden';
      }
    }
    
    function showApp() {
      // Ensure body has proper background
      document.body.style.background = 'var(--bg)';
      document.body.style.minHeight = '100vh';
      document.documentElement.style.background = 'var(--bg)';
      
      // Hide splash screen
      const splash = document.getElementById('splashScreen');
      if (splash) {
        splash.classList.add('hidden');
        splash.style.display = 'none';
        splash.style.visibility = 'hidden';
        splash.style.opacity = '0';
        splash.style.pointerEvents = 'none';
      }
      
      // Ensure all modals are hidden
      hideAuthModal();
      hideOnboardingModal();
      hideHouseholdModal();
      
      // Show the main app content
      if (appContent) {
        appContent.classList.remove('hidden');
        appContent.style.display = 'block';
        appContent.style.visibility = 'visible';
        appContent.style.opacity = '1';
      }
      
      // Reset body overflow
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    }
    
    function hideApp() {
      // Hide the main app content
      if (appContent) {
        appContent.classList.add('hidden');
        appContent.style.display = 'none';
      }
      // Ensure body still has background even when app is hidden
      document.body.style.background = 'var(--bg)';
      document.body.style.minHeight = '100vh';
      document.documentElement.style.background = 'var(--bg)';
    }
    
    // Splash screen is now controlled ONLY by auth state (no manual dismiss)

    // Don't hide auth modal initially - it will be shown when needed
    // hideAuthModal();
    
    // Track if we're still waiting for initial auth check
    // Set this BEFORE initAuth so the callback knows we're still initializing
    let waitingForAuth = true;
    let splashHandled = false; // Flag to prevent multiple splash handlers
    let initializationComplete = false; // Flag to prevent multiple initializations
    let reloadPrevented = false; // Flag to prevent ALL reloads after initialization
    
    // Initialize authentication
    initAuth({
      app,
      db,
      onAuthChange: (user, profile) => {
        currentUserProfile = profile;
        if (user) {
          console.log('User authenticated:', user.email);
          // Always hide modal when user is authenticated
          hideAuthModal();
          waitingForAuth = false;
        } else {
          console.log('User signed out');
          // Only show modal after initial auth check is complete
          // waitForAuth() will handle showing it if needed
          if (!waitingForAuth) {
            showAuthModal();
          }
        }
        updateAuthUI();
      },
      onHouseholdChange: (household) => {
        // Prevent multiple calls from causing issues - check if same household and already initialized
        if (initializationComplete && currentHousehold?.id === household?.id) {
          // Same household, already initialized - just update UI, don't reload
          currentHousehold = household;
          updateAuthUI();
          setTimeout(() => updateInviteCodeButton(), 100);
          return;
        }
        
        currentHousehold = household;
        if (household) {
          console.log('Household loaded:', household.name);
          hideHouseholdModal();
          // If user is authenticated, onboarded, and has household - show app now
          if (currentUserProfile && currentUserProfile.onboardingComplete && household) {
            // Only show app if not already shown (prevent loops)
            if (!initializationComplete) {
              // Force hide splash screen immediately
              splashHandled = true; // Mark as handled to prevent loops
              if (splashScreen) {
                splashScreen.classList.add('hidden');
                splashScreen.style.display = 'none';
              }
              waitingForAuth = false; // Mark as no longer waiting
              showApp();
            }
          }
          // Start app initialization if not already started
          if (!authInitialized) {
            startApp();
            authInitialized = true;
          }
        } else {
          console.log('No household found');
          // Only show household modal if app is not yet initialized
          if (!initializationComplete && currentUserProfile && currentUserProfile.onboardingComplete) {
            showHouseholdModal();
          }
        }
        updateAuthUI();
        setTimeout(() => updateInviteCodeButton(), 100); // Show/hide invite code button based on ownership
      }
    });

    // Wait for auth state to be ready
    waitForAuth().then(async ({ user, profile, household }) => {
      // Prevent other handlers from running
      if (splashHandled) return;
      
      // Keep splash screen visible until we determine what to show
      
      if (user && profile) {
        // User is authenticated - ensure modal is hidden
        currentUserProfile = profile;
        hideAuthModal();
        
        if (!profile.onboardingComplete) {
          // Show onboarding - keep app hidden during onboarding
          hideApp(); // Ensure app is hidden
          
          // Ensure body has background during transition
          document.body.style.background = 'var(--bg)';
          document.body.style.minHeight = '100vh';
          
          if (splashScreen) {
            splashScreen.classList.add('hidden');
            splashScreen.style.display = 'none';
            splashScreen.style.visibility = 'hidden';
            splashScreen.style.opacity = '0';
          }
          
          splashHandled = true; // Mark as handled to prevent loops
          // Small delay to ensure splash is fully hidden before showing modal
          setTimeout(() => {
            showOnboardingModal(profile);
          }, 50);
          return;
        }
        
        if (!household) {
          // Show household creation - keep app hidden
          splashHandled = true; // Mark as handled to prevent loops
          hideApp(); // Ensure app is hidden
          
          // Ensure body has background during transition
          document.body.style.background = 'var(--bg)';
          document.body.style.minHeight = '100vh';
          
          if (splashScreen) {
            splashScreen.classList.add('hidden');
            splashScreen.style.display = 'none';
            splashScreen.style.visibility = 'hidden';
            splashScreen.style.opacity = '0';
          }
          
          // Small delay to ensure splash is fully hidden before showing modal
          setTimeout(() => {
            showHouseholdModal();
          }, 50);
          return;
        }
        
        // User is authenticated, onboarded, and has household - show app
        currentHousehold = household;
        hideAuthModal();
        hideOnboardingModal();
        hideHouseholdModal();
        
        // Hide splash and show app
        splashHandled = true; // Mark as handled to prevent loops
        if (splashScreen) {
          splashScreen.classList.add('hidden');
          splashScreen.style.display = 'none'; // Force hide with inline style
        }
        showApp(); // Show main app content
        
        if (!authInitialized) {
          startApp();
          authInitialized = true;
        }
      } else {
        // No user - show login modal, keep app hidden
        console.log('No user found - showing auth modal');
        splashHandled = true; // Mark as handled to prevent loops
        waitingForAuth = false;
        hideApp(); // Ensure app is hidden
        
        // Ensure body has background during transition
        document.body.style.background = 'var(--bg)';
        document.body.style.minHeight = '100vh';
        
        // Hide splash screen first, then show modal immediately after
        if (splashScreen) {
          splashScreen.classList.add('hidden');
          splashScreen.style.display = 'none';
          splashScreen.style.visibility = 'hidden';
          splashScreen.style.opacity = '0';
        }
        
        // Ensure body background is set BEFORE showing modal
        document.body.style.background = 'var(--bg)';
        document.body.style.minHeight = '100vh';
        document.documentElement.style.background = 'var(--bg)';
        
        // Ensure body background is ALWAYS visible - do this first
        document.body.style.setProperty('background', 'var(--bg)', 'important');
        document.body.style.setProperty('min-height', '100vh', 'important');
        document.body.style.setProperty('width', '100vw', 'important');
        document.documentElement.style.setProperty('background', 'var(--bg)', 'important');
        document.documentElement.style.setProperty('min-height', '100vh', 'important');
        
        // Show modal IMMEDIATELY while splash is still visible (modal behind splash)
        showAuthModal();
        
        // Then hide splash with a very short delay so modal is ready
        if (splashScreen) {
          // Use requestAnimationFrame for smooth transition
          requestAnimationFrame(() => {
            splashScreen.style.transition = 'opacity 0.15s ease-out';
            splashScreen.style.opacity = '0';
            setTimeout(() => {
              splashScreen.classList.add('hidden');
              splashScreen.style.display = 'none';
              splashScreen.style.visibility = 'hidden';
              splashScreen.style.pointerEvents = 'none';
              splashScreen.style.zIndex = '-1';
              // Ensure modal is still visible after splash hides
              showAuthModal();
            }, 150);
          });
        }
        
        // Fallback attempts - ensure modal is always visible
        setTimeout(() => {
          const modal = document.getElementById('authModal');
          if (modal) {
            const computed = window.getComputedStyle(modal);
            const rect = modal.getBoundingClientRect();
            if (computed.display === 'none' || computed.visibility === 'hidden' || rect.width === 0) {
              console.warn('Modal not visible, forcing display');
              showAuthModal();
            }
          }
        }, 250);
      }
      waitingForAuth = false; // Mark that we've completed the initial auth check
      initializationComplete = true;
        GLOBAL_RELOAD_BLOCKED = true; // Mark initialization as complete
      splashHandled = true; // Mark as handled
      reloadPrevented = true; // Prevent ALL reloads after initialization
      GLOBAL_RELOAD_BLOCKED = true; // Block ALL reloads globally
    }).catch(err => {
      console.error('Auth initialization error:', err);
      waitingForAuth = false;
      initializationComplete = true;
        GLOBAL_RELOAD_BLOCKED = true; // Mark initialization as complete even on error
      splashHandled = true; // Mark as handled even on error
      reloadPrevented = true; // Prevent ALL reloads after initialization
      GLOBAL_RELOAD_BLOCKED = true; // Block ALL reloads globally
      
      // Ensure body has background during transition
      document.body.style.background = 'var(--bg)';
      document.body.style.minHeight = '100vh';
      
      // Hide splash on error
      if (splashScreen) {
        splashScreen.classList.add('hidden');
        splashScreen.style.display = 'none';
        splashScreen.style.visibility = 'hidden';
        splashScreen.style.opacity = '0';
      }
      hideApp(); // Ensure app is hidden
      
      // On error, show auth modal immediately
      showAuthModal();
      
      // Also try again after a short delay as fallback
      setTimeout(() => {
        showAuthModal();
      }, 100);
    });
    
    // Absolute maximum timeout: ALWAYS show auth modal after 2 seconds if splash is still visible
    setTimeout(() => {
      if (splashHandled || initializationComplete) {
        console.log('Timeout skipped - already handled or initialized');
        return; // Don't run if already handled
      }
      const splash = document.getElementById('splashScreen');
      if (splash && !splash.classList.contains('hidden')) {
        console.warn('ABSOLUTE TIMEOUT (2s): Forcing auth modal display');
        splashHandled = true; // Mark as handled FIRST to prevent other handlers
        initializationComplete = true;
        GLOBAL_RELOAD_BLOCKED = true; // Mark as complete
        // Force hide splash immediately using multiple methods
        splash.classList.add('hidden');
        splash.style.display = 'none';
        splash.style.visibility = 'hidden';
        splash.style.opacity = '0';
        splash.style.pointerEvents = 'none';
        waitingForAuth = false;
        
        // Check if we have a user
        const user = getCurrentUser();
        const profile = getCurrentUserProfile();
        const household = getCurrentHousehold();
        if (user && profile && household) {
          // User exists - show app
          console.log('Absolute timeout: User exists, showing app');
          showApp();
        } else if (user && profile && !household) {
          // User exists but no household - show household modal
          console.log('Absolute timeout: User exists but no household');
          hideApp();
          showHouseholdModal();
        } else if (user && profile && !profile.onboardingComplete) {
          // User exists but not onboarded - show onboarding
          console.log('Absolute timeout: User exists but not onboarded');
          hideApp();
          showOnboardingModal(profile);
        } else {
          // No user or not authenticated - ALWAYS show auth modal
          console.log('Absolute timeout: Showing auth modal (no user or not authenticated)');
          hideApp();
          showAuthModal();
        }
      }
    }, 2000);
    
    // Immediate check: Show auth modal after 500ms if no user detected
    setTimeout(() => {
      if (splashHandled || initializationComplete) {
        console.log('Early check (500ms) skipped - already handled or initialized');
        return; // Don't run if already handled
      }
      const splash = document.getElementById('splashScreen');
      if (splash && !splash.classList.contains('hidden')) {
        const user = getCurrentUser();
        const profile = getCurrentUserProfile();
        const household = getCurrentHousehold();
        
        if (!user) {
          // No user after 500ms - show auth modal immediately
          console.log('Early check (500ms): No user detected, showing auth modal');
          splashHandled = true; // Mark as handled FIRST
          initializationComplete = true;
        GLOBAL_RELOAD_BLOCKED = true; // Mark as complete
          splash.classList.add('hidden');
          splash.style.display = 'none';
          hideApp();
          waitingForAuth = false;
          showAuthModal();
        } else if (user && profile && household) {
          // User exists - show app immediately
          console.log('Early check (500ms): User exists, showing app');
          splashHandled = true; // Mark as handled FIRST
          initializationComplete = true;
        GLOBAL_RELOAD_BLOCKED = true; // Mark as complete
          splash.classList.add('hidden');
          splash.style.display = 'none';
          showApp();
        }
      }
    }, 500);

    function showOnboardingModal(profile) {
      const modal = document.getElementById('onboardingModal');
      if (!modal) return;
      
      // Ensure splash is fully hidden
      const splash = document.getElementById('splashScreen');
      if (splash) {
        splash.classList.add('hidden');
        splash.style.display = 'none';
        splash.style.visibility = 'hidden';
        splash.style.opacity = '0';
      }
      
      // Ensure body has background
      document.body.style.background = 'var(--bg)';
      document.body.style.minHeight = '100vh';
      document.documentElement.style.background = 'var(--bg)';
      
      // Hide other modals
      hideAuthModal();
      hideHouseholdModal();
      hideApp();
      
      // Pre-fill with Google profile data
      if (profile) {
        document.getElementById('onboardingFirstName').value = profile.firstName || '';
        document.getElementById('onboardingLastName').value = profile.lastName || '';
        document.getElementById('onboardingNickname').value = profile.nickname || '';
        const profileImg = document.getElementById('onboardingProfileImg');
        if (profile.photoURL) {
          profileImg.src = profile.photoURL;
        }
      }
      
      // Force show modal
      modal.classList.add('show');
      modal.style.display = 'block';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.zIndex = '100';
      hideAuthModal();
    }

    function hideOnboardingModal() {
      document.getElementById('onboardingModal')?.classList.remove('show');
    }

    function showHouseholdModal() {
      const modal = document.getElementById('householdModal');
      if (!modal) return;
      
      // Ensure splash is fully hidden
      const splash = document.getElementById('splashScreen');
      if (splash) {
        splash.classList.add('hidden');
        splash.style.display = 'none';
        splash.style.visibility = 'hidden';
        splash.style.opacity = '0';
      }
      
      // Ensure body has background
      document.body.style.background = 'var(--bg)';
      document.body.style.minHeight = '100vh';
      document.documentElement.style.background = 'var(--bg)';
      
      // Hide other modals
      hideAuthModal();
      hideOnboardingModal();
      hideApp();
      
      // Force show modal
      modal.classList.add('show');
      modal.style.display = 'block';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.zIndex = '100';
    }

    function hideHouseholdModal() {
      document.getElementById('householdModal')?.classList.remove('show');
    }

    function updateAuthUI() {
      // Update header with user info if needed
      updateProfileButton();
      updateInviteCodeButton();
    }

    function updateProfileButton() {
      const profileBtn = document.getElementById('profileBtn');
      const profileBtnImg = document.getElementById('profileBtnImg');
      const householdNameText = document.getElementById('householdNameText');
      const user = getCurrentUser();
      const profile = getCurrentUserProfile();
      const household = getCurrentHousehold();
      
      // Update profile button
      if (profileBtn && profileBtnImg) {
        if (user && profile) {
          // Show profile button with user's image
          profileBtn.classList.remove('hidden');
          const photoURL = profile.photoURL || user.photoURL || '/GSH.png';
          profileBtnImg.src = photoURL;
          profileBtnImg.onerror = () => {
            // Fallback to default image if photo fails to load
            profileBtnImg.src = '/GSH.png';
          };
        } else {
          // Hide profile button if no user
          if (profileBtn) {
            profileBtn.classList.add('hidden');
          }
        }
      }
      
      // Update household name display
      if (householdNameText) {
        if (household && household.name) {
          householdNameText.textContent = household.name;
        } else {
          householdNameText.textContent = 'GSH';
        }
      }
    }
    
    function updateInviteCodeButton() {
      const inviteCodeBtn = document.getElementById('inviteCodeBtn');
      const household = getCurrentHousehold();
      const user = getCurrentUser();
      
      // Show button only if user is authenticated, has a household, and is the owner
      if (inviteCodeBtn && household && user && household.ownerId === user.uid) {
        inviteCodeBtn.classList.remove('hidden');
      } else if (inviteCodeBtn) {
        inviteCodeBtn.classList.add('hidden');
      }
    }

    // Functions for invite code modal
    async function showInviteCodeModal() {
      const modal = document.getElementById('inviteCodeModal');
      const codeDisplay = document.getElementById('inviteCodeValue');
      const errorDiv = document.getElementById('inviteCodeError');
      
      if (!modal || !codeDisplay || !errorDiv) {
        console.error('Invite code modal elements not found');
        return;
      }
      
      errorDiv.classList.add('hidden');
      codeDisplay.textContent = '...';
      
      modal.classList.add('show');
      
      // Generate code when modal opens
      try {
        const invite = await generateInviteCode();
        codeDisplay.textContent = invite.code;
      } catch (err) {
        console.error('Error generating invite code:', err);
        errorDiv.textContent = err.message || 'שגיאה ביצירת קוד הזמנה';
        errorDiv.classList.remove('hidden');
        codeDisplay.textContent = '----';
      }
      
      // Load and display household members
      await loadHouseholdMembers();
    }
    
    async function loadHouseholdMembers() {
      const membersList = document.getElementById('householdMembersList');
      if (!membersList) return;
      
      const household = getCurrentHousehold();
      const user = getCurrentUser();
      if (!household || !user) return;
      
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      const firebaseApp = await import('/utils/firebase.js');
      const db = firebaseApp.db;
      
      if (!db) return;
      
      try {
        membersList.innerHTML = '<div class="text-sm text-center" style="color:var(--muted);">טוען...</div>';
        
        const memberIds = household.members || [];
        const isOwner = household.ownerId === user.uid;
        
        if (memberIds.length === 0) {
          membersList.innerHTML = '<div class="text-sm text-center" style="color:var(--muted);">אין חברים במשק הבית</div>';
          return;
        }
        
        // Fetch all user profiles
        const userProfiles = await Promise.all(
          memberIds.map(async (memberId) => {
            try {
              const userRef = doc(db, 'users', memberId);
              const userDoc = await getDoc(userRef);
              if (userDoc.exists()) {
                return { id: memberId, ...userDoc.data() };
              }
              return { id: memberId, displayName: 'Unknown User' };
            } catch (err) {
              console.error('Error loading user:', memberId, err);
              return { id: memberId, displayName: 'Unknown User' };
            }
          })
        );
        
        // Render members list
        membersList.innerHTML = userProfiles.map(member => {
          const isCurrentUser = member.id === user.uid;
          const isOwnerMember = member.id === household.ownerId;
          const photoURL = member.photoURL || '/GSH.png';
          const displayName = member.nickname || member.firstName || member.displayName || 'Unknown';
          const fullName = [member.firstName, member.lastName].filter(Boolean).join(' ') || displayName;
          
          return `
            <div class="flex items-center justify-between gap-2 p-2 rounded-lg border" style="border-color:var(--border); background:var(--input-bg);">
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <img src="${photoURL}" alt="${displayName}" class="w-8 h-8 rounded-full object-cover flex-shrink-0" style="border: 1px solid var(--border);" onerror="this.src='/GSH.png'">
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium truncate" style="color:var(--text);">${displayName}</div>
                  ${fullName !== displayName ? `<div class="text-xs truncate" style="color:var(--muted);">${fullName}</div>` : ''}
                  ${isOwnerMember ? '<div class="text-xs" style="color:var(--accent);">בעלים</div>' : ''}
                </div>
              </div>
              ${isOwner && !isCurrentUser && !isOwnerMember ? `
                <button onclick="removeHouseholdMember('${member.id}')" class="px-3 py-1 text-xs rounded border" style="color:#ef4444; border-color:#ef4444;" title="הסר חבר">הסר</button>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading household members:', err);
        membersList.innerHTML = '<div class="text-sm text-center" style="color:#ef4444;">שגיאה בטעינת חברים</div>';
      }
    }
    
    async function removeHouseholdMember(memberId) {
      if (!confirm('האם אתה בטוח שברצונך להסיר חבר זה ממשק הבית?')) {
        return;
      }
      
      try {
        showLoading('מסיר חבר...');
        const { removeHouseholdMember: removeMember } = await import('/js/modules/auth.js');
        await removeMember(memberId);
        toast('חבר הוסר בהצלחה');
        // Reload members list
        await loadHouseholdMembers();
      } catch (err) {
        console.error('Error removing member:', err);
        toast(err.message || 'שגיאה בהסרת חבר');
      } finally {
        hideLoading();
      }
    }
    
    function showEditHouseholdNameModal() {
      const modal = document.getElementById('editHouseholdNameModal');
      const input = document.getElementById('editHouseholdNameInput');
      const household = getCurrentHousehold();
      
      if (!modal || !input || !household) return;
      
      // Check if user is owner
      const user = getCurrentUser();
      if (!user || household.ownerId !== user.uid) {
        toast('רק בעל משק הבית יכול לערוך את השם');
        return;
      }
      
      input.value = household.name || '';
      document.getElementById('editHouseholdNameError')?.classList.add('hidden');
      modal.classList.add('show');
    }
    
    async function saveHouseholdName() {
      const input = document.getElementById('editHouseholdNameInput');
      const errorDiv = document.getElementById('editHouseholdNameError');
      const modal = document.getElementById('editHouseholdNameModal');
      
      if (!input || !errorDiv) return;
      
      const newName = input.value.trim();
      if (!newName) {
        errorDiv.textContent = 'שם משק הבית לא יכול להיות ריק';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      try {
        showLoading('שומר שם...');
        const { updateHouseholdName } = await import('/js/modules/auth.js');
        await updateHouseholdName(newName);
        
        // Update display
        const householdNameText = document.getElementById('householdNameText');
        if (householdNameText) {
          householdNameText.textContent = newName;
        }
        
        modal?.classList.remove('show');
        toast('שם משק הבית עודכן בהצלחה');
      } catch (err) {
        console.error('Error updating household name:', err);
        errorDiv.textContent = err.message || 'שגיאה בעדכון שם משק הבית';
        errorDiv.classList.remove('hidden');
      } finally {
        hideLoading();
      }
    }

    async function generateNewInviteCode() {
      const codeDisplay = document.getElementById('inviteCodeValue');
      const errorDiv = document.getElementById('inviteCodeError');
      
      if (!codeDisplay || !errorDiv) {
        console.error('Invite code modal elements not found');
        return;
      }
      
      errorDiv.classList.add('hidden');
      codeDisplay.textContent = '...';
      
      try {
        const invite = await generateInviteCode();
        codeDisplay.textContent = invite.code;
      } catch (err) {
        console.error('Error generating invite code:', err);
        errorDiv.textContent = err.message || 'שגיאה ביצירת קוד הזמנה';
        errorDiv.classList.remove('hidden');
        codeDisplay.textContent = '----';
      }
    }

    function copyInviteCode() {
      const codeValueEl = document.getElementById('inviteCodeValue');
      if (!codeValueEl) {
        console.error('Invite code value element not found');
        return;
      }
      
      const codeValue = codeValueEl.textContent;
      if (codeValue && codeValue !== '----' && codeValue !== '...') {
        navigator.clipboard.writeText(codeValue).then(() => {
          const btn = document.getElementById('inviteCodeCopyBtn');
          const originalText = btn.textContent;
          btn.textContent = 'הועתק!';
          btn.style.background = '#10b981';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'var(--accent)';
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy:', err);
        });
      }
    }

    // Profile modal functions
    function showProfileModal() {
      const modal = document.getElementById('profileModal');
      const profile = getCurrentUserProfile();
      const errorDiv = document.getElementById('profileError');
      
      if (!modal || !profile) {
        console.error('Profile modal or profile not available');
        return;
      }
      
      errorDiv.classList.add('hidden');
      
      // Load current profile data
      document.getElementById('profileFirstName').value = profile.firstName || '';
      document.getElementById('profileLastName').value = profile.lastName || '';
      document.getElementById('profileNickname').value = profile.nickname || '';
      
      const profileImg = document.getElementById('profileModalImg');
      const user = getCurrentUser();
      const photoURL = profile.photoURL || user?.photoURL || '/GSH.png';
      profileImg.src = photoURL;
      profileImg.onerror = () => {
        profileImg.src = '/GSH.png';
      };
      
      // Reset file input
      document.getElementById('profileImageFile').value = '';
      
      modal.classList.add('show');
    }

    function hideProfileModal() {
      document.getElementById('profileModal')?.classList.remove('show');
    }

    async function saveProfile() {
      const firstName = document.getElementById('profileFirstName').value.trim();
      const lastName = document.getElementById('profileLastName').value.trim();
      const nickname = document.getElementById('profileNickname').value.trim();
      const errorDiv = document.getElementById('profileError');
      const profileImageFile = document.getElementById('profileImageFile');
      
      errorDiv.classList.add('hidden');
      
      if (!firstName || !lastName) {
        errorDiv.textContent = 'שם פרטי ושם משפחה הם שדות חובה';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      try {
        const updates = {
          firstName,
          lastName,
          nickname
        };
        
        // Handle image upload if a new image was selected
        if (profileImageFile.files?.[0]) {
          showLoading('מעלה תמונה...');
          const { uploadFileAndGetURL } = await import('/js/utils/upload.js');
          const { ref: sref } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js');
          const { getStorage } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js');
          
          const user = getCurrentUser();
          if (user) {
            const storage = getStorage(app);
            const path = `users/${user.uid}/profile-${Date.now()}.jpg`;
            const uploadRef = await uploadFileAndGetURL(sref(storage, path), profileImageFile.files[0]);
            const { getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js');
            updates.photoURL = await getDownloadURL(uploadRef);
          }
        }
        
        // Update profile
        showLoading('שומר פרופיל...');
        await updateUserProfile(updates);
        
        // Update profile button image
        updateProfileButton();
        
        hideProfileModal();
        toast('פרופיל עודכן בהצלחה');
      } catch (err) {
        console.error('Error saving profile:', err);
        errorDiv.textContent = err.message || 'שגיאה בשמירת הפרופיל. נסה שוב.';
        errorDiv.classList.remove('hidden');
      } finally {
        hideLoading();
      }
    }

    // Expose functions globally for onclick handlers
    window.showInviteCodeModal = showInviteCodeModal;
    window.generateNewInviteCode = generateNewInviteCode;
    window.copyInviteCode = copyInviteCode;
    window.showProfileModal = showProfileModal;
    window.showEditHouseholdNameModal = showEditHouseholdNameModal;
    window.saveHouseholdName = saveHouseholdName;
    window.removeHouseholdMember = removeHouseholdMember;

    // Wire up auth modal buttons
    document.getElementById('googleSignInBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('googleSignInBtn');
      const loading = document.getElementById('authLoading');
      const error = document.getElementById('authError');
      
      btn.disabled = true;
      loading.classList.remove('hidden');
      error.classList.add('hidden');
      
      try {
        const result = await signInWithGoogle();
        if (result.needsOnboarding) {
          hideAuthModal();
          showOnboardingModal(currentUserProfile);
        }
        // Auth state change handler will handle the rest
      } catch (err) {
        console.error('Sign in error:', err);
        error.textContent = err.message || 'שגיאה בהתחברות. נסה שוב.';
        error.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Wire up onboarding modal buttons
    document.getElementById('onboardingSave')?.addEventListener('click', async () => {
      const firstName = document.getElementById('onboardingFirstName').value.trim();
      const lastName = document.getElementById('onboardingLastName').value.trim();
      const nickname = document.getElementById('onboardingNickname').value.trim();
      const photoFile = document.getElementById('onboardingPhotoFile').files[0];
      
      const error = document.getElementById('onboardingError');
      error.classList.add('hidden');
      
      try {
        let photoURL = currentUserProfile?.photoURL || '';
        
        // Upload photo if changed
        if (photoFile) {
          const { uploadImage } = await import('/js/utils/upload.js');
          const userId = getCurrentUser()?.uid;
          if (userId) {
            photoURL = await uploadImage(photoFile, `users/${userId}/profile`);
          }
        }
        
        await completeOnboarding({
          firstName,
          lastName,
          nickname,
          photoURL
        });
        
        hideOnboardingModal();
        
        // Check for household
        const household = getCurrentHousehold();
        if (!household) {
          showHouseholdModal();
        } else {
          if (!authInitialized) {
            startApp();
            authInitialized = true;
          }
        }
      } catch (err) {
        console.error('Onboarding error:', err);
        error.textContent = err.message || 'שגיאה בשמירה. נסה שוב.';
        error.classList.remove('hidden');
      }
    });

    document.getElementById('onboardingSkip')?.addEventListener('click', async () => {
      try {
        await completeOnboarding({
          firstName: currentUserProfile?.firstName || '',
          lastName: currentUserProfile?.lastName || '',
          nickname: '',
          photoURL: currentUserProfile?.photoURL || ''
        });
        hideOnboardingModal();
        const household = getCurrentHousehold();
        if (!household) {
          showHouseholdModal();
        } else {
          if (!authInitialized) {
            startApp();
            authInitialized = true;
          }
        }
      } catch (err) {
        console.error('Onboarding skip error:', err);
      }
    });

    document.getElementById('onboardingChangePhoto')?.addEventListener('click', () => {
      document.getElementById('onboardingPhotoFile')?.click();
    });

    document.getElementById('onboardingPhotoFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('onboardingProfileImg').src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Wire up household modal buttons
    document.getElementById('householdCreateBtn')?.addEventListener('click', async () => {
      const name = document.getElementById('householdNameInput').value.trim();
      const error = document.getElementById('householdError');
      
      if (!name) {
        error.textContent = 'אנא הזן שם למשק הבית';
        error.classList.remove('hidden');
        return;
      }
      
      error.classList.add('hidden');
      
      try {
        await createHousehold(name);
        hideHouseholdModal();
        if (!authInitialized) {
          startApp();
          authInitialized = true;
        }
      } catch (err) {
        console.error('Create household error:', err);
        error.textContent = err.message || 'שגיאה ביצירת משק בית. נסה שוב.';
        error.classList.remove('hidden');
      }
    });

    document.getElementById('householdJoinBtn')?.addEventListener('click', async () => {
      const codeInput = document.getElementById('householdInviteCode');
      const code = codeInput.value.trim().replace(/\s/g, '');
      const error = document.getElementById('householdError');
      
      if (!code) {
        error.textContent = 'אנא הזן קוד הזמנה';
        error.classList.remove('hidden');
        return;
      }
      
      // Validate 4-digit code
      if (!/^\d{4}$/.test(code)) {
        error.textContent = 'קוד הזמנה חייב להיות 4 ספרות';
        error.classList.remove('hidden');
        return;
      }
      
      error.classList.add('hidden');
      
      try {
        await joinHouseholdByCode(code);
        hideHouseholdModal();
        if (!authInitialized) {
          startApp();
          authInitialized = true;
        }
      } catch (err) {
        console.error('Join household error:', err);
        error.textContent = err.message || 'שגיאה בהצטרפות למשק בית. בדוק את קוד ההזמנה.';
        error.classList.remove('hidden');
      }
    });

    document.getElementById('householdShowJoin')?.addEventListener('click', () => {
      document.getElementById('householdCreateView').classList.add('hidden');
      document.getElementById('householdJoinView').classList.remove('hidden');
    });

    document.getElementById('householdShowCreate')?.addEventListener('click', () => {
      document.getElementById('householdJoinView').classList.add('hidden');
      document.getElementById('householdCreateView').classList.remove('hidden');
    });

    // Wire up profile modal buttons
    document.getElementById('profileSaveBtn')?.addEventListener('click', saveProfile);
    
    document.getElementById('profileCancelBtn')?.addEventListener('click', () => {
      hideProfileModal();
    });
    
    // Profile image file input preview
    document.getElementById('profileImageFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('profileModalImg').src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Remove image button
    document.getElementById('profileRemoveImage')?.addEventListener('click', () => {
      document.getElementById('profileModalImg').src = '/GSH.png';
      document.getElementById('profileImageFile').value = '';
    });

    /* ---------------- APP INITIALIZATION (wrapped in function) ---------------- */
    async function startApp() {
      console.log('Starting app initialization...');

    /* ---------------- VERSION CHECKING & AUTO-UPDATE ---------------- */
    const APP_VERSION = '0.9';
    
    // Clear all caches and unregister old service workers (aggressive cleanup)
    async function clearAllCaches() {
      if ('caches' in window) {
        try {
          const cacheNames = await caches.keys();
          console.log('[Update] Clearing all caches:', cacheNames);
          await Promise.all(cacheNames.map(name => {
            console.log('[Update] Deleting cache:', name);
            return caches.delete(name);
          }));
        } catch (err) {
          console.error('[Update] Error clearing caches:', err);
        }
      }
    }
    
    // Unregister all service workers
    async function unregisterAllServiceWorkers() {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          console.log('[Update] Found', registrations.length, 'service worker registrations');
          await Promise.all(registrations.map(reg => {
            console.log('[Update] Unregistering service worker:', reg.scope);
            return reg.unregister();
          }));
        } catch (err) {
          console.error('[Update] Error unregistering service workers:', err);
        }
      }
    }
    
    // Force update by clearing everything and reloading
    async function forceUpdate() {
      // COMPLETELY DISABLED: Don't auto-reload - causes infinite loops
      // Only allow manual reloads via user action
      if (reloadPrevented || initializationComplete) {
        console.log('[Update] Skipping force update - app is already running (prevents infinite loops)');
        return;
      }
      console.log('[Update] Force update requested but disabled to prevent loops');
      // DO NOT reload automatically - let user manually refresh
      // await clearAllCaches();
      // await unregisterAllServiceWorkers();
      // window.location.reload(true); // DISABLED
    }
    
    // Check for app updates and force refresh if needed
    async function checkForUpdates() {
      // CRITICAL: Don't set up any update checks if app is already running
      if (GLOBAL_RELOAD_BLOCKED || initializationComplete) {
        console.log('[Update] Skipping update check - app is already running (prevents reload loops)');
        return;
      }
      
      if ('serviceWorker' in navigator) {
        try {
          // First, check if we need to force update (detect old version)
          // DISABLED: Don't auto-update after app is running to prevent loops
          if (!initializationComplete && !reloadPrevented) {
            const storedVersion = localStorage.getItem('gsh-app-version');
            if (storedVersion && storedVersion !== APP_VERSION) {
              console.log('[Update] Version mismatch detected:', storedVersion, '->', APP_VERSION);
              localStorage.setItem('gsh-app-version', APP_VERSION);
              // DO NOT force update - causes infinite loops
              // await forceUpdate();
              // return;
            }
          }
          
          // Store current version
          localStorage.setItem('gsh-app-version', APP_VERSION);
          
          // Register service worker with update check (force fresh fetch)
          const registration = await navigator.serviceWorker.register('/sw.js?v=' + APP_VERSION + '&ts=' + Date.now(), {
            scope: '/',
            updateViaCache: 'none' // Never use cached service worker
          });
          
          // Listen for service worker updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed') {
                  console.log('[Update] New service worker installed');
                  // DISABLED: Don't reload automatically - causes infinite loops
                  // If there's a controller, it means this is an update
                  if (navigator.serviceWorker.controller) {
                    console.log('[Update] New service worker available - will activate on next page load (no auto-reload)');
                    // DO NOT reload - let user manually refresh if needed
                  }
                }
              });
            }
          });
          
          // Check for updates immediately
          try {
            await registration.update();
          } catch (err) {
            console.error('[Update] Error checking for updates:', err);
          }
          
          // Check for updates periodically (every 30 seconds on mobile)
          setInterval(async () => {
            try {
              await registration.update();
            } catch (err) {
              console.error('[Update] Error checking for updates:', err);
            }
          }, 30000); // Check every 30 seconds
          
          // Listen for messages from service worker
          navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'SW_UPDATED') {
              console.log('[Update] Service worker updated to version', event.data.version);
              // DISABLED: Don't reload automatically - causes infinite loops
              // Only allow reload if explicitly forced AND during initialization
              // COMPLETELY DISABLED: Never auto-reload to prevent infinite loops
              console.log('[Update] Service worker updated - skipping auto-reload to prevent loops (user can manually refresh)');
              // DO NOT reload - let user manually refresh if needed
            }
          });
          
          // Also check controller change (happens when new SW takes over)
          // DISABLED: Don't reload automatically - causes infinite loops
          // User can manually refresh if needed
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('[Update] Service worker controller changed - skipping auto-reload to prevent loops');
            // DO NOT reload - let user manually refresh if needed
          });
        } catch (err) {
          console.error('[Update] Error in update check:', err);
        }
      }
      
      // Force fetch index.html on startup to check for updates (bypass cache)
      try {
        const response = await fetch('/index.html?v=' + Date.now(), {
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
          }
        });
      } catch (err) {
        console.warn('[Update] Could not check for updates:', err);
      }
    }
    
    // Check for updates on startup
    // Only check for updates during initial load, not after app is running
    // This prevents infinite reload loops
    if (!initializationComplete && !reloadPrevented) {
      checkForUpdates();
    } else {
      console.log('[Update] Skipping update check - app is already running');
    }
    
    // Add manual refresh function (can be called from console)
    window.forceAppUpdate = forceUpdate;

    /* ---------------- PUSH NOTIFICATIONS ---------------- */
    // Initialize notifications on app load (householdRef is available here)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        const initialized = await initNotifications(householdRef);
        if (initialized) {
          console.log('Push notifications initialized');
          // Update UI if needed
          updateNotificationStatus();
        }
      });
    }
    
    function updateNotificationStatus() {
      const permission = getNotificationPermission();
      if (permission === 'granted') {
        console.log('✅ Notifications enabled');
      } else if (permission === 'denied') {
        console.warn('❌ Notifications blocked');
      } else {
        console.log('⏳ Notification permission pending');
      }
    }

    /* ---------------- IMAGE CACHING ---------------- */
    const IMAGE_CACHE = 'gsh-images-v1';
    
    async function loadImageWithCache(imgElement, url){
      if(!url || url.startsWith('data:') || url.startsWith('/')) {
        imgElement.src = url || '/buy.png';
        return;
      }
      // Firebase Storage URLs should be used directly (they handle CORS properly)
      // Only use cache API for other external URLs
      if(url.includes('firebasestorage.googleapis.com') || url.includes('firebasestorage.app')) {
        imgElement.src = url;
        return;
      }
      try {
        // Try to get from cache first
        const cache = await caches.open(IMAGE_CACHE);
        const cached = await cache.match(url);
        if(cached) {
          const blob = await cached.blob();
          imgElement.src = URL.createObjectURL(blob);
          return;
        }
        // If not in cache, fetch and cache it
        const response = await fetch(url);
        if(response.ok) {
          await cache.put(url, response.clone());
          const blob = await response.blob();
          imgElement.src = URL.createObjectURL(blob);
        } else {
          // If fetch fails, try to use the URL directly
          imgElement.src = url;
        }
      } catch(e) {
        // Silently handle cache errors - just use the URL directly
        // Don't log to console as this is expected for some images
        try {
          imgElement.src = url;
        } catch(err) {
          // If even setting src fails, use fallback
          imgElement.src = '/buy.png';
        }
      }
    }

    // חסימת contextmenu (למעט שדות וקטגוריות)
    document.addEventListener('contextmenu', (e)=>{
      // Allow contextmenu on category buttons
      if(e.target.closest('.cat')) return;
      const allow = e.target.closest('input, textarea, select, [contenteditable="true"]');
      if(!allow) e.preventDefault();
    }, {capture:true});
    

    /* ---------------- STATE ---------------- */
    // Get household from authenticated user context
    const household = getCurrentHousehold();
    const hid = household?.id || null;
    if (!hid) {
      console.error('No household found for authenticated user');
      return;
    }
    const householdRef = doc(db, 'households', hid);

    const firebaseHelpers = {
      collection,
      query,
      where,
      orderBy,
      addDoc,
      updateDoc,
      deleteDoc,
      getDocs,
      getDoc,
      onSnapshot,
      doc,
      setDoc,
      serverTimestamp,
      Timestamp,
      getDownloadURL
    };

    let CATEGORIES = [];
    const CATEGORY_TODO_COUNTS = {};
    const CATEGORY_URGENT_COUNTS = {};
    let ITEMS = {};                // {catId: array}
    let selectedCategory = null;   // id
    let showingAnalytics = false;
    let _itemsUnsub = null;
    let _todoUnsubs = [];
    let parsedImportItems = [];
    const summaryStats = { open:0, urgent:0, weekSpend:0, monthSpend:0 };
    
    // Tasks module state
    let TASK_CATEGORIES = [];
    let TASKS = {};                // {catId: array}
    let selectedTaskCategory = null;
    let currentView = 'shopping';  // 'shopping' or 'tasks'
    let currentTasksTab = 'list';
    
    // Gantt view state
    let ganttViewStart = null;
    let ganttViewEnd = null;

    // תבניות + ערכת נושא
    const TEMPLATES_KEY = 'gsh-templates';
    const THEME_KEY = 'gsh-theme';
    const VIEW_KEY = 'gsh-current-view';
    const SHOPPING_CATEGORY_KEY = 'gsh-shopping-category';
    const TASK_CATEGORY_KEY = 'gsh-task-category';
    const GANTT_VIEW_START_KEY = 'gsh-gantt-view-start';
    const GANTT_VIEW_END_KEY = 'gsh-gantt-view-end';
    let userTemplates = [];
    const PRESET_TEMPLATES = [
      {
        id:'weekend',
        name:'קניות סוף שבוע',
        items:[
          { name:'חלה', qty:2 },
          { name:'יין לקידוש', qty:1, note:'לבחור יין מתוק' },
          { name:'סלט ירוק', qty:1, desc:'מצרכים לסלט: חסה, עגבניות, מלפפונים' },
          { name:'עוף שלם', qty:1 },
          { name:'עוגת שוקולד', qty:1 }
        ]
      },
      {
        id:'basics',
        name:'מצרכים שבועיים בסיסיים',
        items:[
          { name:'חלב 3%', qty:2 },
          { name:'לחם פרוס', qty:1 },
          { name:'ביצים', qty:1, note:'מגש 12' },
          { name:'גבינה צהובה', qty:1 },
          { name:'ירקות מעורבים', qty:1 }
        ]
      },
      {
        id:'hosting',
        name:'אירוח ערב',
        items:[
          { name:'פלטת גבינות', qty:1 },
          { name:'לחם צרפתי', qty:2 },
          { name:'ירקות חתוכים', qty:1 },
          { name:'יין לבן', qty:2 },
          { name:'פירות טריים', qty:1 }
        ]
      }
    ];

    /* ---------------- DOM ---------------- */
    const appLogo = document.getElementById('appLogo');
    const catTitle = document.getElementById('catTitle');
    const importBtn = document.getElementById('importBtn');
    const templatesBtn = document.getElementById('templatesBtn');
    const themeToggle = document.getElementById('themeToggle');
    const searchEl = document.getElementById('search');
    const clearSearchBtn = document.getElementById('clearSearch');
    const openCountEl = document.getElementById('openCount');
    const mainView = document.getElementById('mainView');
    const analyticsView = document.getElementById('analyticsView');
    const shoppingCategoriesList = document.getElementById('shoppingCategoriesList');
    const tasksCategoriesList = document.getElementById('tasksCategoriesList');
    const tasksTabList = document.getElementById('tasksTabList');
    const tasksTabGantt = document.getElementById('tasksTabGantt');
    const tasksListView = document.getElementById('tasksListView');
    const tasksGanttView = document.getElementById('tasksGanttView');
    const notesCategoriesList = document.getElementById('notesCategoriesList');
    const remindersCategoriesList = document.getElementById('remindersCategoriesList');
    
    // Navigation DOM
    const navShopping = document.getElementById('navShopping');
    const navTasks = document.getElementById('navTasks');
    const navNotes = document.getElementById('navNotes');
    const navReminders = document.getElementById('navReminders');
    const tasksView = document.getElementById('tasksView');
    const notesView = document.getElementById('notesView');
    const remindersView = document.getElementById('remindersView');
    const taskCatTitle = document.getElementById('taskCatTitle');
    const tasksList = document.getElementById('tasksList');
    const ganttTimeline = document.getElementById('ganttTimeline');
    const ganttToday = document.getElementById('ganttToday');
    const ganttJumpTo = document.getElementById('ganttJumpTo');
    const ganttPrev = document.getElementById('ganttPrev');
    const ganttNext = document.getElementById('ganttNext');
    const ganttPrevTask = document.getElementById('ganttPrevTask');
    const ganttNextTask = document.getElementById('ganttNextTask');

    // Initialize gantt view state and tasks tabs
    // Provide stub function until module loads, then module will override it
    function loadGanttViewState() {
      try {
        const savedStart = localStorage.getItem(GANTT_VIEW_START_KEY);
        const savedEnd = localStorage.getItem(GANTT_VIEW_END_KEY);
        if (savedStart) ganttViewStart = new Date(parseInt(savedStart));
        if (savedEnd) ganttViewEnd = new Date(parseInt(savedEnd));
      } catch (_) {}
    }
    // Also expose on window for module override
    window.loadGanttViewState = loadGanttViewState;
    // Load saved gantt view state
    loadGanttViewState();
    switchTasksTab('list');
    tasksTabList?.addEventListener('click', () => switchTasksTab('list'));
    tasksTabGantt?.addEventListener('click', () => switchTasksTab('gantt'));
    
    // Gantt expand/collapse state
    
    // Task Editor Modal
    const taskEditModal = document.getElementById('taskEditModal');
    const teId = document.getElementById('teId');
    const teName = document.getElementById('teName');
    const teStartDate = document.getElementById('teStartDate');
    const teEndDate = document.getElementById('teEndDate');
    const teResponsibility = document.getElementById('teResponsibility');
    const teStatus = document.getElementById('teStatus');
    const teCategory = document.getElementById('teCategory');
    const teDetails = document.getElementById('teDetails');
    const teSave = document.getElementById('teSave');
    const teDelete = document.getElementById('teDelete');

    // מודלים (קטגוריה)
    const catModal = document.getElementById('catModal');
    const catIdEl = document.getElementById('catId');
    const catName = document.getElementById('catName');
    const catPinned = document.getElementById('catPinned');
    const catFile = document.getElementById('catFile');
    const catFileName = document.getElementById('catFileName');
    const catPreview = document.getElementById('catPreview');
    const catSave = document.getElementById('catSave');
    const catDelete = document.getElementById('catDelete');
    const catModalTitle = document.getElementById('catModalTitle');

    // מודל הוספת פריט
    const qaModal = document.getElementById('quickAddModal');
    const qaName = document.getElementById('qaName');
    const qaDesc = document.getElementById('qaDesc');
    const qaNote = document.getElementById('qaNote');
    const qaQty = document.getElementById('qaQty');
    const qaPrice = document.getElementById('qaPrice');
    const qaFile = document.getElementById('qaFile');
    const qaFileName = document.getElementById('qaFileName');
    const qaSave = document.getElementById('qaSave');

    // מודל עריכת פריט
    const ieModal = document.getElementById('itemEditModal');
    const ieId = document.getElementById('ieId');
    const ieName = document.getElementById('ieName');
    const ieDesc = document.getElementById('ieDesc');
    const ieNote = document.getElementById('ieNote');
    const ieQty = document.getElementById('ieQty');
    const iePrice = document.getElementById('iePrice');
    const ieFile = document.getElementById('ieFile');
    const ieFileName = document.getElementById('ieFileName');
    const iePreview = document.getElementById('iePreview');
    const ieCategory = document.getElementById('ieCategory');
    const ieSave = document.getElementById('ieSave');
    const ieDelete = document.getElementById('ieDelete');

    const shoppingModule = initShopping({
      householdRef,
      storage,
      firebase: firebaseHelpers,
      sref,
      summaryStats,
      updateSummaryUI,
      getCurrentView: () => currentView
    });

    const notesModule = initNotes({
      householdRef,
      firebase: firebaseHelpers,
      sref,
      storage,
      getCurrentView: () => currentView
    });

    const remindersModule = initReminders({
      householdRef,
      firebase: firebaseHelpers,
      sref,
      storage,
      getCurrentView: () => currentView,
      getNotesSnapshot: () => notesModule?.getNotes() || []
    });

    const analyticsModule = initAnalytics({
      householdRef,
      firebase: firebaseHelpers,
      summaryStats,
      updateSummaryUI
    });

    // Initialize tasks module
    const tasksModule = initTasks({
      householdRef,
      firebase: firebaseHelpers,
      sref,
      storage,
      getCurrentView: () => currentView,
      db: db
    });

    // מודל ייבוא
    const importModal = document.getElementById('importModal');
    const importCategorySelect = document.getElementById('importCategory');
    const importTextArea = document.getElementById('importText');
    const importPreview = document.getElementById('importPreview');
    const importCountEl = document.getElementById('importCount');
    const importErrorsEl = document.getElementById('importErrors');
    const importAddBtn = document.getElementById('importAddBtn');

    // אנליטיקות
    const summaryOpenEl = document.getElementById('summaryOpen');
    const summaryUrgentEl = document.getElementById('summaryUrgent');
    const summaryWeekEl = document.getElementById('summaryWeek');
    const summaryMonthEl = document.getElementById('summaryMonth');

    // מודל תבניות
    const templatesModal = document.getElementById('templatesModal');
    const templateCategorySelect = document.getElementById('templateCategorySelect');
    const userTemplatesList = document.getElementById('userTemplatesList');
    const presetTemplatesList = document.getElementById('presetTemplatesList');
    const templateNameInput = document.getElementById('templateNameInput');
    const templateSaveBtn = document.getElementById('templateSaveBtn');

    /* ---------------- HELPERS ---------------- */
    const catsCol  = collection(householdRef, 'categories');
    const itemsCol = collection(householdRef, 'items');

    const fmtMoney = (n)=> '₪'+Number(n||0).toFixed(2);
    const parseDateStr = (s)=>{
      if(!s || typeof s !== 'string') return new Date(); // fallback
      const parts = s.split('-').map(Number);
      if(parts.length !== 3) return new Date(); // fallback
      const [y,m,d] = parts;
      const date = new Date(y, m-1, d);
      // Validate date is valid
      if(isNaN(date.getTime()) || date.getFullYear() !== y || date.getMonth() !== m-1 || date.getDate() !== d){
        console.warn('Invalid date string:', s);
        return new Date(); // fallback to today
      }
      return date;
    };
    const iso = (date)=> {
      if(!date || !(date instanceof Date) || isNaN(date.getTime())) return new Date().toISOString().slice(0,10);
      return date.toISOString().slice(0,10);
    };
    function isoWeekKey(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }
    function toast(msg, duration = 1500){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), duration);
    }
    
    // Loading state helpers
    function showLoading(text = 'טוען...'){
      const overlay = document.getElementById('loadingOverlay');
      const textEl = document.getElementById('loadingText');
      if(textEl) textEl.textContent = text;
      overlay.classList.remove('hidden');
      overlay.classList.add('flex');
    }
    function hideLoading(){
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
    }
    
    // Input validation helpers
    function validateQuantity(qty){
      const num = Number(qty);
      if(isNaN(num) || num < 0) return { valid: false, error: 'כמות חייבת להיות מספר חיובי' };
      if(num > 10000) return { valid: false, error: 'כמות גדולה מדי (מקסימום 10000)' };
      return { valid: true, value: Math.round(num) };
    }
    
    function validatePrice(price){
      const num = Number(price);
      if(isNaN(num) || num < 0) return { valid: false, error: 'מחיר חייב להיות מספר חיובי' };
      if(num > 100000) return { valid: false, error: 'מחיר גדול מדי (מקסימום 100000)' };
      return { valid: true, value: Math.round(num * 100) / 100 }; // Round to 2 decimals
    }
    
    function validateName(name){
      const trimmed = (name || '').trim();
      if(!trimmed) return { valid: false, error: 'שם נדרש' };
      if(trimmed.length > 100) return { valid: false, error: 'שם ארוך מדי (מקסימום 100 תווים)' };
      return { valid: true, value: trimmed };
    }
    function updateSummaryFromCounters(){
      summaryStats.open = Object.values(CATEGORY_TODO_COUNTS).reduce((sum,val)=> sum + (val||0), 0);
      summaryStats.urgent = Object.values(CATEGORY_URGENT_COUNTS).reduce((sum,val)=> sum + (val||0), 0);
      updateSummaryUI();
    }
    function updateSummaryUI(){
      if(summaryOpenEl) summaryOpenEl.textContent = String(summaryStats.open || 0);
      if(summaryUrgentEl) summaryUrgentEl.textContent = String(summaryStats.urgent || 0);
      if(summaryWeekEl) summaryWeekEl.textContent = fmtMoney(summaryStats.weekSpend || 0);
      if(summaryMonthEl) summaryMonthEl.textContent = fmtMoney(summaryStats.monthSpend || 0);
    }
    function applyTheme(mode){
      const isDark = mode === 'dark';
      document.body.classList.toggle('dark-mode', isDark);
      const iconEl = document.getElementById('themeIcon');
      if(iconEl) iconEl.textContent = isDark ? '☀️' : '🌙';
      try{ localStorage.setItem(THEME_KEY, mode); }catch(_){}
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      const preferred = saved || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      applyTheme(preferred);
      themeToggle?.addEventListener('click', ()=>{
        const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        applyTheme(next);
        navigator.vibrate?.(12);
      });
    }
    initTheme();
    
    /* ---------------- NAVIGATION ---------------- */
    const appBarTitle = document.getElementById('appBarTitle');
    
    function switchView(view){
      currentView = view;
      try{ localStorage.setItem(VIEW_KEY, view); }catch(_){}
      
      // Get category bars (get fresh references each time to ensure they exist)
      const shoppingNav = document.getElementById('shoppingCategoriesNav');
      const tasksNav = document.getElementById('tasksCategoriesNav');
      const notesNav = document.getElementById('notesCategoriesNav');
      const remindersNav = document.getElementById('remindersCategoriesNav');
      
      // Hide all views
      mainView.classList.add('hidden');
      analyticsView.classList.add('hidden');
      tasksView.classList.add('hidden');
      notesView.classList.add('hidden');
      remindersView.classList.add('hidden');
      
      // Hide all category bars and clear their content
      const shoppingNavEl = document.getElementById('shoppingCategoriesNav');
      const tasksNavEl = document.getElementById('tasksCategoriesNav');
      const notesNavEl = document.getElementById('notesCategoriesNav');
      const remindersNavEl = document.getElementById('remindersCategoriesNav');
      const shoppingCategoriesList = document.getElementById('shoppingCategoriesList');
      const tasksCategoriesList = document.getElementById('tasksCategoriesList');
      const notesCategoriesList = document.getElementById('notesCategoriesList');
      const remindersCategoriesList = document.getElementById('remindersCategoriesList');
      
      if(shoppingNavEl) {
        shoppingNavEl.style.setProperty('display', 'none', 'important');
        shoppingNavEl.style.setProperty('visibility', 'hidden', 'important');
      }
      if(shoppingCategoriesList && view !== 'shopping') {
        shoppingCategoriesList.innerHTML = '';
      }
      
      if(tasksNavEl) {
        tasksNavEl.style.setProperty('display', 'none', 'important');
        tasksNavEl.style.setProperty('visibility', 'hidden', 'important');
      }
      if(tasksCategoriesList && view !== 'tasks') {
        tasksCategoriesList.innerHTML = '';
      }
      
      if(notesNavEl) {
        notesNavEl.style.setProperty('display', 'none', 'important');
        notesNavEl.style.setProperty('visibility', 'hidden', 'important');
      }
      if(notesCategoriesList && view !== 'notes') {
        notesCategoriesList.innerHTML = '';
      }
      
      if(remindersNavEl) {
        remindersNavEl.style.setProperty('display', 'none', 'important');
        remindersNavEl.style.setProperty('visibility', 'hidden', 'important');
      }
      if(remindersCategoriesList && view !== 'reminders') {
        remindersCategoriesList.innerHTML = '';
      }
      
      // Remove active from all nav buttons
      navShopping?.classList.remove('active');
      navTasks?.classList.remove('active');
      navNotes?.classList.remove('active');
      navReminders?.classList.remove('active');
      
      if(view === 'shopping'){
        // Hide analytics if showing when switching to shopping (if it was shown from elsewhere)
        if(showingAnalytics && currentView !== 'shopping'){
          showingAnalytics = false;
          analyticsView.classList.add('hidden');
        }
        mainView.classList.remove('hidden');
        navShopping?.classList.add('active');
        navTasks?.classList.remove('active');
        navNotes?.classList.remove('active');
        navReminders?.classList.remove('active');
        if (appBarTitle) appBarTitle.textContent = 'רשימת קניות';
        // Shopping category bar is inside mainView, so it will be visible when mainView is visible
        const shoppingNavEl = document.getElementById('shoppingCategoriesNav');
        if(shoppingNavEl) {
          shoppingNavEl.style.setProperty('display', 'block', 'important');
          shoppingNavEl.style.setProperty('visibility', 'visible', 'important');
        }
        // Always try to render categories (will be empty if data hasn't loaded yet)
        // The onSnapshot callback will call renderCategories() again when data arrives
        renderCategories();
        // Ensure items are loaded for selected category
        if(selectedCategory) {
          attachItemsListener(selectedCategory);
        } else if(CATEGORIES.length > 0) {
          // If no category selected but categories exist, select first
          selectCategory(CATEGORIES[0].id);
        }
      } else if(view === 'tasks'){
        // Hide analytics when switching away from shopping
        if(showingAnalytics){
          showingAnalytics = false;
          analyticsView.classList.add('hidden');
        }
        tasksView.classList.remove('hidden');
        navShopping?.classList.remove('active');
        navTasks?.classList.add('active');
        navNotes?.classList.remove('active');
        navReminders?.classList.remove('active');
        if (appBarTitle) appBarTitle.textContent = 'משימות';
        // Tasks category bar is inside tasksView, so it will be visible when tasksView is visible
        const tasksNavEl = document.getElementById('tasksCategoriesNav');
        if(tasksNavEl) {
          tasksNavEl.style.setProperty('display', 'block', 'important');
          tasksNavEl.style.setProperty('visibility', 'visible', 'important');
        }
        // Use module's render functions if available, otherwise use inline versions
        if(typeof window !== 'undefined' && window.renderTaskCategories) {
          window.renderTaskCategories();
        } else if(TASK_CATEGORIES.length === 0) {
          loadTaskCategories();
        } else {
          renderTaskCategories();
          renderTaskCategoriesBottomBar();
        }
        // Use module's switchTasksTab if available
        if(typeof window !== 'undefined' && window.switchTasksTab) {
          window.switchTasksTab(currentTasksTab);
        } else {
          switchTasksTab(currentTasksTab);
        }
      } else if(view === 'notes'){
        // Hide analytics when switching away from shopping
        if(showingAnalytics){
          showingAnalytics = false;
          analyticsView.classList.add('hidden');
        }
        notesView.classList.remove('hidden');
        navShopping?.classList.remove('active');
        navTasks?.classList.remove('active');
        navNotes?.classList.add('active');
        navReminders?.classList.remove('active');
        if (appBarTitle) appBarTitle.textContent = 'פתקים';
      } else if(view === 'reminders'){
        // Hide analytics when switching away from shopping
        if(showingAnalytics){
          showingAnalytics = false;
          analyticsView.classList.add('hidden');
        }
        remindersView.classList.remove('hidden');
        navShopping?.classList.remove('active');
        navTasks?.classList.remove('active');
        navNotes?.classList.remove('active');
        navReminders?.classList.add('active');
        if (appBarTitle) appBarTitle.textContent = 'תזכורות';
      }

      // Call each module's handleViewChange to ensure proper category hiding/showing
      notesModule?.handleViewChange(view);
      remindersModule?.handleViewChange(view);
      tasksModule?.handleViewChange(view);
      
      // Show/hide FABs based on current view
      const fabShopping = document.getElementById('fabShopping');
      const fabTasks = document.getElementById('fabTasks');
      const fabNotes = document.getElementById('fabNotes');
      const fabReminders = document.getElementById('fabReminders');
      
      if (fabShopping) fabShopping.classList.toggle('hidden', view !== 'shopping');
      if (fabTasks) fabTasks.classList.toggle('hidden', view !== 'tasks');
      if (fabNotes) fabNotes.classList.toggle('hidden', view !== 'notes');
      if (fabReminders) fabReminders.classList.toggle('hidden', view !== 'reminders');

      // Show/hide app bar actions based on current view
      const actionsShopping = document.getElementById('appBarActionsShopping');
      const actionsTasks = document.getElementById('appBarActionsTasks');
      const actionsNotes = document.getElementById('appBarActionsNotes');
      const actionsReminders = document.getElementById('appBarActionsReminders');

      if (actionsShopping) actionsShopping.classList.toggle('hidden', view !== 'shopping');
      if (actionsTasks) actionsTasks.classList.toggle('hidden', view !== 'tasks');
      if (actionsNotes) actionsNotes.classList.toggle('hidden', view !== 'notes');
      if (actionsReminders) actionsReminders.classList.toggle('hidden', view !== 'reminders');
    }
    navShopping?.addEventListener('click', ()=> switchView('shopping'));
    navTasks?.addEventListener('click', ()=> switchView('tasks'));
    navNotes?.addEventListener('click', ()=> switchView('notes'));
    navReminders?.addEventListener('click', ()=> switchView('reminders'));
    
    // Category bars are now inside their respective screens, so they're automatically hidden when screens are hidden
    
    // Switch to saved view after a short delay to allow initial data load
    // Category loaders will be called after their collections are defined
    setTimeout(() => {
      const savedView = localStorage.getItem(VIEW_KEY);
      if(savedView && ['shopping', 'tasks', 'notes', 'reminders'].includes(savedView)){
        switchView(savedView);
      } else {
        switchView('shopping'); // Default to shopping
      }
    }, 300);
    updateSummaryUI();
    /* ---------------- LOGO dblclick ---------------- */
    let last=0;
    if (appLogo) {
      appLogo.addEventListener('click', ()=>{
        const now=Date.now();
        if(now-last<300){
          // Only toggle analytics when on shopping screen
          if(currentView === 'shopping'){
            showingAnalytics = !showingAnalytics;
            mainView.classList.toggle('hidden', showingAnalytics);
            analyticsView.classList.toggle('hidden', !showingAnalytics);
            if(showingAnalytics){ analyticsModule?.showDefault(); }
          }
          last=0;
        } else last=now;
      });
    }

    /* ---------------- CATEGORIES ---------------- */
    // Set up categories listener - Firestore persistentLocalCache should provide immediate data
    // Use getDocs first to ensure cache is primed, then set up real-time listener
    getDocs(query(catsCol, orderBy('order','asc'))).then((qs)=>{
      CATEGORIES = qs.docs.map(d => {
        const data = d.data();
        return {
          id: d.id,
          label: data.label,
          img: data.img || '',
          order: data.order ?? 0,
          pinned: !!data.pinned
        };
      }).sort((a,b)=>{
        const pinnedDiff = Number(b.pinned) - Number(a.pinned);
        if(pinnedDiff !== 0) return pinnedDiff;
        return (a.order ?? 0) - (b.order ?? 0);
      });
      // Render immediately with cached data
      renderCategories();
      attachCategoryTodoCounters();
      const savedShoppingCat = localStorage.getItem(SHOPPING_CATEGORY_KEY);
      if(savedShoppingCat && CATEGORIES.find(c=>c.id===savedShoppingCat)){
        selectCategory(savedShoppingCat);
      } else if(!selectedCategory && CATEGORIES.length) {
        selectCategory(CATEGORIES[0].id);
      }
      if(currentView === 'shopping') {
        const shoppingNavEl = document.getElementById('shoppingCategoriesNav');
        if(shoppingNavEl) {
          shoppingNavEl.style.display = 'block';
          shoppingNavEl.style.visibility = 'visible';
        }
      }
    }).catch(console.error);
    
    // Then set up real-time listener for updates
    console.log('Setting up onSnapshot listener for shopping categories...');
    onSnapshot(query(catsCol, orderBy('order','asc')), (qs)=>{
      console.log('onSnapshot fired with', qs.size, 'categories');
      CATEGORIES = qs.docs.map(d => {
        const data = d.data();
        return {
          id: d.id,
          label: data.label,
          img: data.img || '',
          order: data.order ?? 0,
          pinned: !!data.pinned
        };
      }).sort((a,b)=>{
        const pinnedDiff = Number(b.pinned) - Number(a.pinned);
        if(pinnedDiff !== 0) return pinnedDiff;
        return (a.order ?? 0) - (b.order ?? 0);
      });
      console.log('onSnapshot: CATEGORIES updated to', CATEGORIES.length, 'items');
      // Always render categories when data arrives
      renderCategories();
      attachCategoryTodoCounters();
      // Restore saved shopping category or select first
      const savedShoppingCat = localStorage.getItem(SHOPPING_CATEGORY_KEY);
      if(savedShoppingCat && CATEGORIES.find(c=>c.id===savedShoppingCat)){
        selectCategory(savedShoppingCat);
      } else if(!selectedCategory && CATEGORIES.length) {
        selectCategory(CATEGORIES[0].id);
      } else if(selectedCategory && CATEGORIES.length > 0) {
        // Ensure items are loaded for current category
        attachItemsListener(selectedCategory);
      }
      // Always ensure category bar is visible if on shopping view
      if(currentView === 'shopping') {
        const shoppingNavEl = document.getElementById('shoppingCategoriesNav');
        if(shoppingNavEl) {
          shoppingNavEl.style.setProperty('display', 'block', 'important');
          shoppingNavEl.style.setProperty('visibility', 'visible', 'important');
        }
      }
    }, (err) => {
      console.error('onSnapshot error for shopping categories:', err);
    });

    function renderCategories(){
      const shoppingCategoriesList = document.getElementById('shoppingCategoriesList');
      if(!shoppingCategoriesList) return;
      // Only render and show shopping category bar if we're on shopping view
      if(currentView !== 'shopping') {
        const shoppingNavEl = document.getElementById('shoppingCategoriesNav');
        if(shoppingNavEl) {
          shoppingNavEl.style.setProperty('display', 'none', 'important');
          shoppingNavEl.style.setProperty('visibility', 'hidden', 'important');
        }
        return;
      }
      shoppingCategoriesList.innerHTML = '';
      for(const c of CATEGORIES){
        const holder = document.createElement('button');
        holder.className = 'cat flex flex-col items-center w-16 relative';
        holder.dataset.id = c.id;
        holder.innerHTML = `
          ${c.pinned ? '<span class="absolute top-0 left-1 text-amber-500 text-xs">★</span>' : ''}
          <span class="badge hidden" style="display: none !important; visibility: hidden !important;"></span>
          <img class="w-14 h-14 rounded-full border object-cover ${c.id===selectedCategory?'selected':''}" src="${c.img||'/cat.png'}" alt="">
          <span class="text-[11px] mt-1 text-center truncate">${c.label||''}</span>
        `;
        applyCategoryBadge(holder, c.id);
        holder.addEventListener('click', ()=> selectCategory(c.id));
        holder.addEventListener('dblclick', ()=> openCatEditor('edit', c.id));
        holder.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openQuickAdd(c.id); });
        // Load category image with cache
        const catImg = holder.querySelector('img');
        if(catImg && c.img && !c.img.startsWith('/')) {
          loadImageWithCache(catImg, c.img);
        }
        shoppingCategoriesList.appendChild(holder);
      }
      // כפתור הוספה
      const addBtn = document.createElement('button');
      addBtn.className = 'cat flex flex-col items-center w-16';
      addBtn.innerHTML = `<img class="w-14 h-14 rounded-full border object-cover" src="/add.png" alt=""><span class="text-[11px] mt-1">הוסף</span>`;
      addBtn.addEventListener('click', ()=> openCatEditor('create'));
      shoppingCategoriesList.appendChild(addBtn);

      const cur = CATEGORIES.find(c=>c.id===selectedCategory);
      if (catTitle) catTitle.textContent = cur ? cur.label : 'קטגוריות';
      drawItems();
      populateImportCategoryOptions();
      populateTemplateCategoryOptions();
      refreshAllCategoryBadges();
    }

    function attachCategoryTodoCounters(){
      _todoUnsubs.forEach(fn=>{ try{fn();}catch(_){}}); _todoUnsubs=[];
      for(const c of CATEGORIES){
        const qref = query(itemsCol, where('category','==', c.id), where('status','==','todo'));
        const unsub = onSnapshot(qref, (qs)=>{
          CATEGORY_TODO_COUNTS[c.id] = qs.size || 0;
          let urgentCount = 0;
          qs.forEach(docSnap=>{
            const data = docSnap.data();
            if(data?.urgent) urgentCount++;
          });
          CATEGORY_URGENT_COUNTS[c.id] = urgentCount;
          refreshAllCategoryBadges();
          updateSummaryFromCounters();
        });
        _todoUnsubs.push(unsub);
      }
    }

    function selectCategory(catId){
      selectedCategory = catId;
      try{ localStorage.setItem(SHOPPING_CATEGORY_KEY, catId || ''); }catch(_){}
      const cur = CATEGORIES.find(c=>c.id===catId);
      if (catTitle) catTitle.textContent = cur ? cur.label : 'קטגוריות';
      attachItemsListener(catId);
      renderCategories();
    }

    function applyCategoryBadge(holder, catId){
      if(!holder) return;
      const badge = holder.querySelector('.badge');
      if(!badge) return;
      const count = CATEGORY_TODO_COUNTS[catId] || 0;
      if(count > 0){
        badge.textContent = String(count);
        badge.classList.remove('hidden');
        badge.style.display = 'flex';
        badge.style.visibility = 'visible';
      } else {
        badge.textContent = ''; // Clear any text
        badge.classList.add('hidden');
        badge.style.display = 'none';
        badge.style.visibility = 'hidden';
      }
    }

    function refreshAllCategoryBadges(){
      shoppingCategoriesList?.querySelectorAll('.cat[data-id]').forEach(holder=>{
        const id=holder.dataset.id;
        applyCategoryBadge(holder, id);
      });
    }

    function populateImportCategoryOptions(){
      if(!importCategorySelect) return;
      importCategorySelect.innerHTML = '';
      if(!CATEGORIES.length){
        const opt=document.createElement('option');
        opt.value='';
        opt.textContent='אין קטגוריות זמינות';
        importCategorySelect.appendChild(opt);
        importCategorySelect.disabled = true;
        return;
      }
      importCategorySelect.disabled = false;
      for(const c of CATEGORIES){
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.label || '—';
        importCategorySelect.appendChild(opt);
      }
      const defaultId = selectedCategory || CATEGORIES[0]?.id || '';
      if(defaultId) importCategorySelect.value = defaultId;
    }

    function populateTemplateCategoryOptions(){
      if(!templateCategorySelect) return;
      templateCategorySelect.innerHTML = '';
      if(!CATEGORIES.length){
        const opt=document.createElement('option');
        opt.value='';
        opt.textContent='אין קטגוריות זמינות';
        templateCategorySelect.appendChild(opt);
        templateCategorySelect.disabled = true;
        return;
      }
      templateCategorySelect.disabled = false;
      for(const c of CATEGORIES){
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.label || '—';
        templateCategorySelect.appendChild(opt);
      }
      const defaultId = selectedCategory || CATEGORIES[0]?.id || '';
      if(defaultId) templateCategorySelect.value = defaultId;
    }

    /* ---------------- CATEGORY EDITOR ---------------- */
    function openCatEditor(mode='create', catId=null){
      catIdEl.value = catId||'';
      catName.value=''; catPreview.src='/cat.png';
      catPinned.checked = false;
      catFile.value=''; catFileName.textContent='לא נבחרה תמונה';
      catDelete.classList.toggle('hidden', mode!=='edit');
      catModalTitle.textContent = (mode==='edit') ? 'עריכת קטגוריה' : 'קטגוריה חדשה';
      if(mode==='edit' && catId){
        const c=CATEGORIES.find(x=>x.id===catId);
        if(c){
          catName.value=c.label||'';
          catPreview.src=c.img||'/cat.png';
          catPinned.checked = !!c.pinned;
        }
      }
      catModal.classList.add('show');
    }
    // OLD INLINE CODE - NOW HANDLED BY SHOPPING MODULE
    // Category save/delete handlers are in shopping.js module

    /* ---------------- QUICK ADD ITEM ---------------- */
    // OLD INLINE CODE - NOW HANDLED BY SHOPPING MODULE
    // Quick add handlers are in shopping.js module

    /* ---------------- ITEMS ---------------- */
    // OLD INLINE CODE - NOW HANDLED BY SHOPPING MODULE
    /*
    function attachItemsListener(catId){
      if(!catId) return;
      if(_itemsUnsub) _itemsUnsub();
      _itemsUnsub = onSnapshot(query(itemsCol, where('category','==', catId)), (qs)=>{
        ITEMS[catId] = qs.docs.map(d=>({ id:d.id, ...d.data() }));
        drawItems();
      }, (error) => {
        console.error('Error loading items:', error);
        // Try to load from cache if online fetch fails
        if(error.code === 'unavailable') {
          toast('מצב offline - טוען מקאש', 2000);
        }
      });
    }
    */

    // OLD INLINE CODE - NOW HANDLED BY SHOPPING MODULE
    // Debounced search for better performance
    /*
    let searchTimeout = null;
    const debouncedDrawItems = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(drawItems, 300);
    };
    ['input','change','keyup','search'].forEach(ev=> searchEl.addEventListener(ev, debouncedDrawItems));
    clearSearchBtn.addEventListener('click', ()=>{ searchEl.value=''; drawItems(); searchEl.focus(); });

    function drawItems(){
      const all = selectedCategory ? (ITEMS[selectedCategory]||[]) : [];
      const raw=(searchEl.value||'').trim().toLowerCase();
      const filtered = raw ? all.filter(i => (i.name||'').toLowerCase().includes(raw)) : all;

      const container = document.getElementById('mainView');
      container.innerHTML='';
      clearSearchBtn.classList.toggle('hidden', !raw);

      if(!selectedCategory){ openCountEl.textContent='—'; container.innerHTML='<div class="p-4" style="color:var(--muted);">בחר קטגוריה.</div>'; return; }
      if(!filtered.length){ openCountEl.textContent='אין פריטים'; container.innerHTML='<div class="p-4" style="color:var(--muted);">אין פריטים בקטגוריה הזו.</div>'; return; }

      filtered.sort((a,b)=>{
        const sa=a.status==='done'?1:0, sb=b.status==='done'?1:0; if(sa!==sb) return sa-sb;
        const ta=a.createdAt?.toMillis?.()||0, tb=b.createdAt?.toMillis?.()||0;
        return tb - ta;
      });

      const open = filtered.filter(i=>i.status!=='done').length;
      openCountEl.textContent = `${open} פריטים`;

      for(const item of filtered){
        const row=document.createElement('div');
        row.className='row bg-white border rounded-xl p-3 flex items-center gap-3 '+(item.status==='done'?'purchased':'');
        if(item.urgent && item.status!=='done') row.classList.add('urgent');
        row.dataset.id=item.id;

        const img=document.createElement('img');
        img.alt=''; img.className='w-12 h-12 rounded-full border object-cover';
        // Load image with caching
        loadImageWithCache(img, item.img||'/buy.png');
        img.addEventListener('contextmenu', e=>e.preventDefault());

        const text=document.createElement('div'); text.className='flex-1 min-w-0';
        const t=document.createElement('div'); t.className='title font-semibold text-sm md:text-base truncate'; t.textContent=item.name||'';
        const d=document.createElement('div'); d.className='desc text-xs truncate'; d.style.color='var(--muted)'; d.textContent=item.desc||'';
        text.append(t,d);
        if(item.note){
          const note=document.createElement('div');
          note.className='text-[11px] text-amber-600 truncate';
          note.textContent=item.note;
          text.appendChild(note);
        }

        const qty=document.createElement('div'); qty.className='flex items-center gap-2';
        const minus=document.createElement('button'); minus.className='w-8 h-8 border rounded-full'; minus.textContent='−';
        const qv=document.createElement('div'); qv.textContent=Number(item.qty||0);
        const plus=document.createElement('button'); plus.className='w-8 h-8 border rounded-full'; plus.textContent='+';
        minus.addEventListener('click', ()=>{
          navigator.vibrate?.(8);
          updateDoc(doc(householdRef,'items',item.id), { qty:Math.max(0,Number(item.qty||0)-1), updatedAt: serverTimestamp() });
        });
        plus.addEventListener('click',  ()=>{
          navigator.vibrate?.(8);
          updateDoc(doc(householdRef,'items',item.id), { qty:Number(item.qty||0)+1, updatedAt: serverTimestamp() });
        });
        if(item.status==='done'){ minus.classList.add('opacity-60'); plus.classList.add('opacity-60'); }
        qty.append(minus,qv,plus);

        const badges=document.createElement('div');
        badges.className='flex flex-col items-end gap-2 min-w-[90px]';
        const urgency=document.createElement('button');
        urgency.className='text-xs px-2 py-1 rounded border transition';
        if(item.urgent){
          urgency.classList.add('bg-amber-100','text-amber-800','border-amber-200');
        }else{
          urgency.style.color='var(--muted)';
          urgency.style.borderColor='var(--border)';
        }
        urgency.textContent = item.urgent ? 'דחוף' : 'רגיל';
        urgency.title='לחץ לשינוי דחיפות';
        urgency.addEventListener('click', ()=>{
          navigator.vibrate?.(10);
          updateDoc(doc(householdRef,'items',item.id), { urgent: !item.urgent, updatedAt: serverTimestamp() })
            .catch(()=> toast('שגיאה בעדכון דחיפות'));
        });
        badges.appendChild(urgency);

        const price=document.createElement('div'); price.className='px-2 py-1 border rounded min-w-16 text-center text-sm '+(item.status==='done'?'opacity-60':'');
        price.textContent = fmtMoney(Number(item.price||0));
        price.addEventListener('dblclick', ()=>{
          const currentPrice = item.price ?? 0;
          const input = prompt('עדכון מחיר ליחידה (₪):', currentPrice);
          if(input === null) return; // User cancelled
          const priceVal = validatePrice(input);
          if(!priceVal.valid){ toast(priceVal.error); return; }
          updateDoc(doc(householdRef,'items',item.id), { price:priceVal.value, updatedAt: serverTimestamp() })
            .catch(e=>{ console.error(e); toast('שגיאה בעדכון מחיר'); });
        });

        attachRowInteractions(row, item);

        badges.appendChild(price);

        row.append(img, text, qty, badges);
        container.appendChild(row);
      }
    }
    */

    // Store cleanup functions for row interactions to prevent memory leaks
    const rowCleanups = new WeakMap();

    function attachRowInteractions(row, item){
      // Clean up previous listeners if they exist
      if(rowCleanups.has(row)){
        const cleanup = rowCleanups.get(row);
        cleanup();
      }
      
      let sx=0, sy=0, dx=0, dragging=false, longTimer=null, longFired=false;
      const TH=60, TOLY=15, LONG=500;
      const reset=()=>{ row.style.transform='translateX(0px)'; row.classList.remove('dragging'); };
      const clearLong=()=>{ if(longTimer){ clearTimeout(longTimer); longTimer=null; } };

      const handlePointerDown = (e)=>{ 
        dragging=true; sx=e.clientX; sy=e.clientY; dx=0; 
        row.classList.add('dragging'); longFired=false;
        clearLong(); longTimer=setTimeout(()=>{ longFired=true; openItemEditor(item); }, LONG);
      };
      
      const handlePointerMove = (e)=>{ 
        if(!dragging) return;
        const adx=e.clientX-sx, ady=e.clientY-sy;
        if(Math.abs(ady)>TOLY){ dragging=false; clearLong(); reset(); return; }
        dx=adx; row.style.transform=`translateX(${dx}px)`; if(Math.abs(dx)>10) clearLong();
      };
      
      const handlePointerUp = async ()=>{ 
        row.classList.remove('dragging');
        if(!longFired){
          if(dx>TH)      await setPurchased(item, true);
          else if(dx<-TH)await setPurchased(item, false);
        }
        clearLong(); dragging=false; reset();
      };
      
      const handlePointerLeave = ()=>{ 
        if(dragging){ dragging=false; clearLong(); reset(); } 
      };

      row.addEventListener('pointerdown', handlePointerDown);
      row.addEventListener('pointermove', handlePointerMove);
      row.addEventListener('pointerup', handlePointerUp);
      row.addEventListener('pointerleave', handlePointerLeave);
      
      // Store cleanup function
      rowCleanups.set(row, ()=>{
        row.removeEventListener('pointerdown', handlePointerDown);
        row.removeEventListener('pointermove', handlePointerMove);
        row.removeEventListener('pointerup', handlePointerUp);
        row.removeEventListener('pointerleave', handlePointerLeave);
        if(longTimer) clearTimeout(longTimer);
      });
    }

    async function setPurchased(item, done){
      await updateDoc(doc(householdRef,'items', item.id), { status: done?'done':'todo', updatedAt: serverTimestamp() });
      if(done) await logPurchase(item);
      toast(done?'סומן כנקנה':'הוחזר ללא נקנה');
    }

    async function logPurchase(item){
      const qty=Math.max(0,Number(item.qty||0));
      const price=Math.max(0,Number(item.price||0));
      const cost=+(qty*price).toFixed(2);
      const d=new Date();
      const date=iso(d);
      const cat=CATEGORIES.find(c=>c.id===item.category);
      await addDoc(collection(householdRef,'purchaseEvents'),{
        ts: serverTimestamp(),
        date,
        itemId:item.id,
        itemNameSnapshot:item.name||'',
        itemImgSnapshot:item.img||'/buy.png',
        categoryId:item.category||'',
        categoryNameSnapshot:cat?.label||'',
        categoryImgSnapshot:cat?.img||'/cat.png',
        qtyAtPurchase: qty,
        unitPrice: price,
        cost
      });
    }

    /* ---------------- ITEM EDITOR ---------------- */
    function openItemEditor(item){
      ieId.value=item.id;
      ieName.value=item.name||'';
      ieDesc.value=item.desc||'';
      ieNote.value=item.note||'';
      ieQty.value=Number(item.qty||0);
      iePrice.value=Number(item.price||0);
      ieFile.value=''; ieFileName.textContent='לא נבחרה תמונה';
      iePreview.src=item.img||'/buy.png';

      ieCategory.innerHTML='';
      if(CATEGORIES.length===0){
        const opt=document.createElement('option'); opt.value=''; opt.textContent='— אין קטגוריות —'; ieCategory.appendChild(opt);
      } else {
        for(const c of CATEGORIES){
          const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.label||'—';
          if((item.category||selectedCategory)===c.id) opt.selected=true;
          ieCategory.appendChild(opt);
        }
      }
      ieModal.classList.add('show');
    }
    // OLD INLINE CODE - NOW HANDLED BY SHOPPING MODULE
    // Item edit save/delete handlers are in shopping.js module

    /* ---------------- IMPORT MODAL ---------------- */
    importBtn?.addEventListener('click', openImportModal);
    // Add button for shopping items (hidden, FAB is used instead)
    const handleAddShoppingItem = () => {
      if(selectedCategory) {
        openQuickAdd(selectedCategory);
      } else if(CATEGORIES.length > 0) {
        openQuickAdd(CATEGORIES[0].id);
      } else {
        toast('אנא בחר קטגוריה תחילה');
      }
    };
    document.getElementById('addShoppingItemBtn')?.addEventListener('click', handleAddShoppingItem);
    
    // FAB for shopping items
    document.getElementById('fabShopping')?.addEventListener('click', handleAddShoppingItem);
    
    // FAB for tasks - wire to openTaskEditor with null (create mode)
    document.getElementById('fabTasks')?.addEventListener('click', () => {
      if (typeof window !== 'undefined' && window.openTaskEditor) {
        window.openTaskEditor(null);
      }
    });
    
    // FAB for notes - wire to openNoteEditor with create mode
    document.getElementById('fabNotes')?.addEventListener('click', () => {
      if (typeof window !== 'undefined' && window.openNoteEditor) {
        window.openNoteEditor('create');
      }
    });
    
    // FAB for reminders - wire to openReminderEditor with create mode
    document.getElementById('fabReminders')?.addEventListener('click', () => {
      if (typeof window !== 'undefined' && window.openReminderEditor) {
        window.openReminderEditor('create');
      }
    });
    document.querySelectorAll('#importModal [data-close]').forEach(el=> el.addEventListener('click',()=> closeImportModal()));
    importTextArea?.addEventListener('input', ()=> updateImportPreview(importTextArea.value));
    importCategorySelect?.addEventListener('change', ()=> updateImportPreview(importTextArea.value));
    importAddBtn?.addEventListener('click', importParsedItems);

    function openImportModal(){
      populateImportCategoryOptions();
      parsedImportItems = [];
      importErrorsEl.classList.add('hidden');
      importErrorsEl.textContent='';
      importTextArea.value='';
      updateImportPreview('');
      importModal.classList.add('show');
      setTimeout(()=> importTextArea.focus(), 10);
    }

    function closeImportModal(){
      importModal.classList.remove('show');
    }

    function updateImportPreview(text){
      parsedImportItems = parseImportText(text||'');
      if(parsedImportItems.length>100){
        importErrorsEl.textContent = 'אפשר להדביק עד 100 פריטים בכל פעם.';
        importErrorsEl.classList.remove('hidden');
        parsedImportItems = parsedImportItems.slice(0,100);
      } else {
        importErrorsEl.classList.add('hidden');
        importErrorsEl.textContent='';
      }
      importCountEl.textContent = `${parsedImportItems.length} פריטים`;
      const catUnavailable = importCategorySelect?.disabled || !importCategorySelect?.value;
      importAddBtn.disabled = parsedImportItems.length===0 || catUnavailable;
      if(parsedImportItems.length===0){
        importPreview.innerHTML = '<div style="color:var(--muted);">אין פריטים עדיין.</div>';
        return;
      }
      importPreview.innerHTML = parsedImportItems.map(item=>`
        <div class="flex items-center justify-between bg-white border rounded px-2 py-1">
          <div class="font-medium truncate">${item.name}</div>
          <div class="text-xs flex items-center gap-2" style="color:var(--muted);">
            <span>×${item.qty}</span>
            ${item.desc ? `<span class="truncate max-w-[140px]">${item.desc}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    function parseImportText(text){
      const lines = text.split(/\r?\n/);
      const items = [];
      for(const line of lines){
        const parsed = parseImportLine(line);
        if(parsed) items.push(parsed);
      }
      return items;
    }

    function parseImportLine(raw){
      if(!raw) return null;
      let line = raw.trim();
      if(!line) return null;
      line = line.replace(/^[•\-\*\u2022]+/, '').trim();
      if(!line) return null;
      let qty = 1;

      const qtyMatch = line.match(/(?:x|×|\*)\s*(\d+)/i);
      if(qtyMatch){
        qty = Number(qtyMatch[1]);
        line = line.replace(qtyMatch[0], '').trim();
      } else {
        const leadingQty = line.match(/^(\d+)\s*[x×*]?\s+(.*)$/);
        if(leadingQty){
          qty = Number(leadingQty[1]);
          line = leadingQty[2].trim();
        }
      }

      let name = line;
      let desc = '';
      const split = line.split(/[-–—|,]/);
      if(split.length>1){
        name = split.shift().trim();
        desc = split.join('-').trim();
      }
      if(!name) return null;
      qty = Math.min(10000, Math.max(1, qty || 1));
      return { name, desc, qty };
    }

    async function importParsedItems(){
      if(!parsedImportItems.length){ toast('אין פריטים לייבוא'); return; }
      const catId = importCategorySelect?.value || selectedCategory;
      if(!catId){ toast('בחר קטגוריה לייבוא'); return; }
      showLoading('מייבא פריטים...');
      try{
        for(const item of parsedImportItems){
          await addDoc(itemsCol, {
            name: item.name,
            desc: item.desc,
            note: item.note || '',
            qty: item.qty,
            price: 0,
            img: '/buy.png',
            status: 'todo',
            category: catId,
            createdAt: serverTimestamp()
          });
        }
        closeImportModal();
        toast(`יובאו ${parsedImportItems.length} פריטים`);
      }catch(e){
        console.error(e);
        toast(e.message?.includes('network') ? 'בעיית רשת - נסה שוב' : 'שגיאה בזמן הייבוא', 3000);
      }finally{
        hideLoading();
      }
    }

    /* ---------------- TEMPLATES ---------------- */
    loadUserTemplates();

    templatesBtn?.addEventListener('click', openTemplatesModal);
    document.querySelectorAll('#templatesModal [data-close]').forEach(el=> el.addEventListener('click',()=> closeTemplatesModal()));
    templateSaveBtn?.addEventListener('click', saveTemplateFromCurrent);
    userTemplatesList?.addEventListener('click', handleTemplateListClick);
    presetTemplatesList?.addEventListener('click', handleTemplateListClick);

    function loadUserTemplates(){
      try{
        userTemplates = JSON.parse(localStorage.getItem(TEMPLATES_KEY)) || [];
      }catch(_){
        userTemplates = [];
      }
    }
    function persistUserTemplates(){
      try{
        localStorage.setItem(TEMPLATES_KEY, JSON.stringify(userTemplates));
      }catch(e){
        console.warn('Failed to persist templates', e);
      }
    }
    function openTemplatesModal(){
      populateTemplateCategoryOptions();
      renderTemplateLists();
      templatesModal?.classList.add('show');
    }
    function closeTemplatesModal(){
      templatesModal?.classList.remove('show');
    }
    function renderTemplateLists(){
      renderTemplateSection(userTemplatesList, userTemplates, true, 'אין לכם עדיין תבניות שמורות.');
      renderTemplateSection(presetTemplatesList, PRESET_TEMPLATES, false, 'ניתן להוסיף תבניות מוכנות מראש.');
    }
    function renderTemplateSection(container, list, deletable=false, emptyText=''){
      if(!container) return;
      container.innerHTML='';
      if(!list || list.length===0){
        container.innerHTML = `<div class="text-sm" style="color:var(--muted);">${emptyText}</div>`;
        return;
      }
      for(const tmpl of list){
        const card=document.createElement('div');
        card.className='border rounded-lg p-3 flex flex-col gap-2';
        card.style.background = 'var(--card)';
        card.style.color = 'var(--text)';
        card.style.borderColor = 'var(--border)';
        card.style.opacity = '0.9';
        const itemsPreview = (tmpl.items||[]).map(i=>i.name).slice(0,4).join(' · ');
        card.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="font-semibold truncate">${tmpl.name||'—'}</div>
            <div class="text-xs" style="color:var(--muted);">${tmpl.items?.length||0} פריטים</div>
          </div>
          <div class="text-xs truncate" style="color:var(--muted);">${itemsPreview}</div>
          <div class="flex gap-2 justify-end">
            ${deletable?'<button class="template-delete text-xs px-2 py-1 border rounded" data-action="delete" data-template-id="'+tmpl.id+'" data-kind="user">מחק</button>':''}
            <button class="template-apply text-xs px-3 py-1 rounded bg-black text-white" data-action="apply" data-template-id="${tmpl.id}" data-kind="${deletable?'user':'preset'}">הוסף</button>
          </div>
        `;
        container.appendChild(card);
      }
    }
    function handleTemplateListClick(event){
      const btn = event.target.closest('button[data-template-id]');
      if(!btn) return;
      const id = btn.dataset.templateId;
      const kind = btn.dataset.kind;
      const action = btn.dataset.action;
      if(!id || !kind) return;
      if(action==='delete'){
        userTemplates = userTemplates.filter(t=> t.id!==id);
        persistUserTemplates();
        renderTemplateLists();
        toast('התבנית נמחקה');
      }else if(action==='apply'){
        applyTemplate(kind, id);
      }
    }
    async function applyTemplate(kind, id){
      const source = kind==='user' ? userTemplates : PRESET_TEMPLATES;
      const tmpl = source.find(t=> t.id===id);
      if(!tmpl){ toast('התבנית לא נמצאה'); return; }
      const catId = templateCategorySelect?.value || selectedCategory;
      if(!catId){ toast('בחר קטגוריה ליישום התבנית'); return; }
      showLoading('מוסיף תבנית...');
      try{
        for(const item of (tmpl.items||[])){
          await addDoc(itemsCol, {
            name: item.name,
            desc: item.desc || '',
            note: item.note || '',
            qty: Math.max(1, Number(item.qty||1)),
            price: Number(item.price||0),
            img: '/buy.png',
            status: 'todo',
            urgent: !!item.urgent,
            category: catId,
            createdAt: serverTimestamp()
          });
        }
        toast('התבנית נוספה לרשימה');
        closeTemplatesModal();
      }catch(e){
        console.error(e);
        toast(e.message?.includes('network') ? 'בעיית רשת - נסה שוב' : 'שגיאה ביישום התבנית', 3000);
      }finally{
        hideLoading();
      }
    }
    function saveTemplateFromCurrent(){
      const name=(templateNameInput?.value||'').trim();
      if(!name){ toast('צריך שם לתבנית'); return; }
      if(!selectedCategory){ toast('בחרו קטגוריה פעילה לשמירה'); return; }
      const sourceItems = ITEMS[selectedCategory];
      if(!sourceItems){ toast('הנתונים עדיין נטענים, נסו שוב בעוד רגע'); return; }
      const currentItems = sourceItems.filter(i=> i.status!=='done');
      if(!currentItems.length){ toast('אין פריטים פעילים לשמירה'); return; }
      const payload = currentItems.map(i=>({
        name: i.name || '',
        desc: i.desc || '',
        note: i.note || '',
        qty: Math.max(1, Number(i.qty||1))
      }));
      userTemplates.push({ id:`tpl-${Date.now()}`, name, items: payload });
      persistUserTemplates();
      templateNameInput.value='';
      renderTemplateLists();
      toast('התבנית נשמרה');
    }

    /* ---------------- TASKS MODULE ---------------- */
    const taskCatsCol = collection(householdRef, 'taskCategories');
    const tasksCol = collection(householdRef, 'tasks');
    
    // Initialize task categories after collection is defined
    loadTaskCategories();
    
    function loadTaskCategories(){
      // Use getDocs first to ensure cache is primed
      getDocs(query(taskCatsCol, orderBy('order','asc'))).then((qs)=>{
        TASK_CATEGORIES = qs.docs.map(d => ({ 
          id:d.id, 
          label:d.data().label, 
          color:d.data().color || '#3b82f6', 
          img:d.data().img || null,
          pinned:d.data().pinned || false,
          order:d.data().order ?? 0 
        }));
        TASK_CATEGORIES.sort((a, b) => {
          if(a.pinned && !b.pinned) return -1;
          if(!a.pinned && b.pinned) return 1;
          return (a.order || 0) - (b.order || 0);
        });
        if(currentView === 'tasks') {
          renderTaskCategories();
          renderTaskCategoriesBottomBar();
        }
        const savedTaskCat = localStorage.getItem(TASK_CATEGORY_KEY);
        if(savedTaskCat && TASK_CATEGORIES.find(c=>c.id===savedTaskCat)){
          selectTaskCategory(savedTaskCat);
        } else if(!selectedTaskCategory && TASK_CATEGORIES.length) {
          selectTaskCategory(TASK_CATEGORIES[0].id);
        }
      }).catch(console.error);
      
      // Then set up real-time listener for updates
      onSnapshot(query(taskCatsCol, orderBy('order','asc')), (qs)=>{
        TASK_CATEGORIES = qs.docs.map(d => ({ 
          id:d.id, 
          label:d.data().label, 
          color:d.data().color || '#3b82f6', 
          img:d.data().img || null,
          pinned:d.data().pinned || false,
          order:d.data().order ?? 0 
        }));
        // Sort by pinned first, then by order
        TASK_CATEGORIES.sort((a, b) => {
          if(a.pinned && !b.pinned) return -1;
          if(!a.pinned && b.pinned) return 1;
          return (a.order || 0) - (b.order || 0);
        });
        renderTaskCategories();
        renderTaskCategoriesBottomBar();
        // Restore saved task category
        const savedTaskCat = localStorage.getItem(TASK_CATEGORY_KEY);
        if(savedTaskCat && TASK_CATEGORIES.find(c=>c.id===savedTaskCat)){
          selectTaskCategory(savedTaskCat);
        } else if(!selectedTaskCategory && TASK_CATEGORIES.length) {
          selectTaskCategory(TASK_CATEGORIES[0].id);
        }
      });
    }
    
    function switchTasksTab(tab){
      if(!tasksTabList || !tasksTabGantt || !tasksListView || !tasksGanttView) return;
      currentTasksTab = tab;
      if(tab === 'list'){
        tasksListView.classList.remove('hidden');
        tasksGanttView.classList.add('hidden');
        // Style list button as active
        tasksTabList.style.background = 'var(--accent)';
        tasksTabList.style.color = 'var(--bg)';
        tasksTabList.style.borderColor = 'var(--accent)';
        // Style gantt button as inactive
        tasksTabGantt.style.background = 'transparent';
        tasksTabGantt.style.color = 'var(--text)';
        tasksTabGantt.style.borderColor = 'var(--border)';
      } else {
        tasksListView.classList.add('hidden');
        tasksGanttView.classList.remove('hidden');
        // Style gantt button as active
        tasksTabGantt.style.background = 'var(--accent)';
        tasksTabGantt.style.color = 'var(--bg)';
        tasksTabGantt.style.borderColor = 'var(--accent)';
        // Style list button as inactive
        tasksTabList.style.background = 'transparent';
        tasksTabList.style.color = 'var(--text)';
        tasksTabList.style.borderColor = 'var(--border)';
        requestAnimationFrame(()=> {
          renderGantt();
        });
      }
    }
    
    function renderTaskCategories(){
      const cur = TASK_CATEGORIES.find(c=>c.id===selectedTaskCategory);
      if (taskCatTitle) taskCatTitle.textContent = cur ? cur.label : 'קטגוריות משימות';
      renderTasks();
      if(currentTasksTab === 'gantt'){
      renderGantt();
      }
      renderTaskCategoriesBottomBar();
    }
    
    function renderTaskCategoriesBottomBar(){
      const tasksCategoriesList = document.getElementById('tasksCategoriesList');
      if(!tasksCategoriesList) return;
      // Only render and show tasks category bar if we're on tasks view
      if(currentView !== 'tasks') {
        const tasksNavEl = document.getElementById('tasksCategoriesNav');
        if(tasksNavEl) {
          tasksNavEl.style.setProperty('display', 'none', 'important');
          tasksNavEl.style.setProperty('visibility', 'hidden', 'important');
        }
        return;
      }
      tasksCategoriesList.innerHTML = '';
      for(const c of TASK_CATEGORIES){
        const holder = document.createElement('button');
        holder.className = 'cat flex flex-col items-center w-16 relative';
        holder.dataset.id = c.id;
        const taskCount = (TASKS[c.id] || []).filter(t => t.status !== 'finished' && t.status !== 'canceled').length;
        holder.innerHTML = `
          ${c.pinned ? '<span class="absolute top-0 left-1 text-amber-500 text-xs">★</span>' : ''}
          ${taskCount > 0 ? `<span class="badge">${taskCount}</span>` : '<span class="badge hidden" style="display: none !important; visibility: hidden !important;"></span>'}
          ${c.img ? 
            `<img class="w-14 h-14 rounded-full border object-cover ${c.id===selectedTaskCategory?'selected':''}" src="${c.img}" alt="" style="border-color:var(--border);">` :
            `<div class="w-14 h-14 rounded-full border-2 flex items-center justify-center ${c.id===selectedTaskCategory?'selected':''}" style="border-color: ${c.color}; background: ${c.color}20;">
              <div class="w-10 h-10 rounded-full" style="background: ${c.color};"></div>
            </div>`
          }
          <span class="text-[11px] mt-1 text-center truncate">${c.label||''}</span>
        `;
        let clickTimer = null;
        holder.addEventListener('click', (e)=>{
          if(clickTimer){
            clearTimeout(clickTimer);
            clickTimer = null;
            return; // Double-click detected, ignore single click
          }
          clickTimer = setTimeout(()=>{
            selectTaskCategory(c.id);
            clickTimer = null;
          }, 250);
        });
        holder.addEventListener('dblclick', (e)=>{
          e.preventDefault();
          e.stopPropagation();
          if(clickTimer){
            clearTimeout(clickTimer);
            clickTimer = null;
          }
          openTaskCategoryEditor('edit', c.id);
        });
        holder.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openTaskEditor(null); });
        tasksCategoriesList.appendChild(holder);
      }
      // כפתור הוספה - Add button for creating new category
      const addBtn = document.createElement('button');
      addBtn.className = 'cat flex flex-col items-center w-16';
      addBtn.innerHTML = `<img class="w-14 h-14 rounded-full border object-cover" src="/add.png" alt=""><span class="text-[11px] mt-1">הוסף</span>`;
      addBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        openTaskCategoryEditor('create');
      });
      tasksCategoriesList.appendChild(addBtn);
    }
    
    function selectTaskCategory(catId){
      selectedTaskCategory = catId;
      try{ localStorage.setItem(TASK_CATEGORY_KEY, catId || ''); }catch(_){}
      const cur = TASK_CATEGORIES.find(c=>c.id===catId);
      if (taskCatTitle) taskCatTitle.textContent = cur ? cur.label : 'קטגוריות משימות';
      attachTasksListener(catId);
      renderTaskCategories();
      renderTaskCategoriesBottomBar();
    }
    
    function attachTasksListener(catId){
      if(_tasksUnsub) _tasksUnsub();
      // Query without orderBy to avoid errors when startDate is null
      _tasksUnsub = onSnapshot(query(tasksCol, where('category','==', catId)), (qs)=>{
        TASKS[catId] = qs.docs.map(d=>({ id:d.id, ...d.data() }));
        // Sort manually: tasks with dates first, then by date
        TASKS[catId].sort((a,b)=>{
          if(!a.startDate && !b.startDate) return 0;
          if(!a.startDate) return 1;
          if(!b.startDate) return -1;
          return a.startDate.seconds - b.startDate.seconds;
        });
        renderTasks();
        if(currentTasksTab === 'gantt'){
        renderGantt();
        }
        renderTaskCategoriesBottomBar(); // Update badge counts
      });
    }
    let _tasksUnsub = null;
    
    function formatTaskDetails(text){
      if(!text) return '';
      // Convert phone numbers to clickable links
      text = text.replace(/(\+?972|0)?-?([0-9]{2})-?([0-9]{3})-?([0-9]{4})/g, '<a href="tel:$&">$&</a>');
      // Convert URLs to clickable links
      text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
      // Convert email-like patterns
      text = text.replace(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/g, '<a href="mailto:$1">$1</a>');
      return text;
    }
    
    function isTaskOverdue(task){
      if(!task.endDate || task.status === 'finished' || task.status === 'canceled') return false;
      const endDate = new Date(task.endDate.seconds * 1000);
      endDate.setHours(23, 59, 59); // End of day
      return new Date() > endDate;
    }
    
    function getStatusClass(status){
      const classes = {
        'todo': 'task-status-todo',
        'in_progress': 'task-status-in_progress',
        'finished': 'task-status-finished',
        'canceled': 'task-status-canceled'
      };
      return classes[status] || 'task-status-todo';
    }
    
    function getStatusLabel(status){
      const labels = {
        'todo': 'לעשות',
        'in_progress': 'בתהליך',
        'finished': 'הושלם',
        'canceled': 'בוטל'
      };
      return labels[status] || 'לעשות';
    }
    
    function renderTasks(){
      const all = selectedTaskCategory ? (TASKS[selectedTaskCategory]||[]) : [];
      tasksList.innerHTML = '';
      if(!selectedTaskCategory){
        tasksList.innerHTML = '<div class="p-4 text-center" style="color:var(--muted);">בחר קטגוריה</div>';
        return;
      }
      if(all.length === 0){
        tasksList.innerHTML = '<div class="p-4 text-center" style="color:var(--muted);">אין משימות בקטגוריה זו</div>';
        return;
      }
      
      // Sort: overdue first, then by status, then by date
      all.sort((a,b)=>{
        const aOverdue = isTaskOverdue(a);
        const bOverdue = isTaskOverdue(b);
        if(aOverdue !== bOverdue) return bOverdue ? 1 : -1;
        const statusOrder = { 'todo': 0, 'in_progress': 1, 'finished': 2, 'canceled': 3 };
        if(statusOrder[a.status] !== statusOrder[b.status]) return statusOrder[a.status] - statusOrder[b.status];
        const aDate = a.startDate ? new Date(a.startDate.seconds * 1000) : new Date(0);
        const bDate = b.startDate ? new Date(b.startDate.seconds * 1000) : new Date(0);
        return aDate - bDate;
      });
      
      for(const task of all){
        const overdue = isTaskOverdue(task);
        const row = document.createElement('div');
        row.className = `border rounded-xl p-3 ${getStatusClass(task.status || 'todo')} ${overdue ? 'task-overdue' : ''} ${task.status==='finished' || task.status==='canceled' ? 'opacity-70' : ''}`;
        row.style.background = 'var(--card)';
        row.style.color = 'var(--text)';
        row.style.borderColor = 'var(--border)';
        row.dataset.id = task.id;
        
        const content = document.createElement('div');
        content.className = 'flex items-start gap-3 w-full';
        
        const left = document.createElement('div');
        left.className = 'flex-1 min-w-0';
        
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-2 mb-1';
        const title = document.createElement('div');
        title.className = `font-semibold text-base ${task.status==='finished' || task.status==='canceled' ? 'line-through' : ''}`;
        title.textContent = task.name || 'ללא שם';
        header.appendChild(title);
        
        const statusBadge = document.createElement('div');
        statusBadge.className = 'text-xs px-2 py-0.5 rounded';
        const statusColors = {
          'todo': 'bg-yellow-100 text-yellow-800',
          'in_progress': 'bg-blue-100 text-blue-800',
          'finished': 'bg-green-100 text-green-800',
          'canceled': 'bg-gray-100 text-gray-800'
        };
        statusBadge.className += ' ' + (statusColors[task.status] || statusColors.todo);
        statusBadge.textContent = getStatusLabel(task.status || 'todo');
        header.appendChild(statusBadge);
        
        const meta = document.createElement('div');
        meta.className = 'text-xs space-y-0.5';
        meta.style.color = 'var(--muted)';
        
        // Dates
        if(task.startDate){
          const start = new Date(task.startDate.seconds * 1000);
          const dateStr = start.toLocaleDateString('he-IL');
          meta.innerHTML += `<div>מתחיל: ${dateStr}</div>`;
        }
        if(task.endDate){
          const end = new Date(task.endDate.seconds * 1000);
          const dateStr = end.toLocaleDateString('he-IL');
          const endClass = overdue ? 'text-red-600 font-semibold' : '';
          meta.innerHTML += `<div class="${endClass}">${overdue ? '⚠️ ' : ''}מסתיים: ${dateStr}</div>`;
        }
        
        // Responsibility
        if(task.responsibility){
          meta.innerHTML += `<div>אחריות: ${task.responsibility === 'Hadar' ? 'הדר' : 'גיל'}</div>`;
        }
        
        // Details with clickable links
        if(task.details){
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'task-details text-xs mt-2 p-2 rounded';
          detailsDiv.style.background = 'var(--input-bg)';
          detailsDiv.style.color = 'var(--muted)';
          detailsDiv.innerHTML = formatTaskDetails(task.details);
          meta.appendChild(detailsDiv);
        }
        
        left.append(header, meta);
        
        const right = document.createElement('div');
        right.className = 'flex flex-col items-end gap-2';
        
        const cat = TASK_CATEGORIES.find(c=>c.id===task.category);
        const colorBadge = document.createElement('div');
        colorBadge.className = 'w-6 h-6 rounded-full';
        colorBadge.style.backgroundColor = cat?.color || '#3b82f6';
        colorBadge.title = cat?.label || '';
        right.appendChild(colorBadge);
        
        content.append(left, right);
        row.appendChild(content);
        
        row.addEventListener('click', (e)=>{
          if(e.target.tagName === 'A') return; // Don't open editor when clicking links
          openTaskEditor(task);
        });
        tasksList.appendChild(row);
      }
    }
    
    function getTaskColor(task){
      if(!task.endDate) return '#6b7280'; // No due date - gray
      if(task.status === 'finished') return '#10b981'; // Finished - green
      if(task.status === 'canceled') return '#6b7280'; // Canceled - gray
      
      const now = new Date();
      const endDate = new Date(task.endDate.seconds * 1000);
      endDate.setHours(23, 59, 59);
      const daysUntilDue = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
      
      if(daysUntilDue < 0) return '#ef4444'; // Past due - red
      if(daysUntilDue <= 3) return '#f97316'; // Due in 0-3 days - orange
      if(daysUntilDue <= 7) return '#fbbf24'; // Due this week - yellow
      if(daysUntilDue <= 14) return '#84cc16'; // Due in 2 weeks - light green
      return '#3b82f6'; // Future - blue
    }
    
    // OLD renderGantt - commented out, using module version from tasks.js instead
    // This old version had date calculation issues with setDate()
    /*
    function renderGantt(){
      if(!ganttTimeline) return;
      const allTasks = Object.values(TASKS).flat().filter(t => t.startDate && t.endDate);
      if(allTasks.length === 0){
        ganttTimeline.innerHTML = '<div class="p-4 text-center" style="color:var(--text);">אין משימות עם תאריכים להצגה</div>';
        return;
      }
      
      const now = new Date();
      // Use view state if set, otherwise default to 7 days back, 30 days forward
      let startDate = ganttViewStart ? new Date(ganttViewStart) : new Date(now);
      if(!ganttViewStart) startDate.setDate(startDate.getDate() - 7);
      startDate.setHours(0, 0, 0, 0); // Normalize to start of day
      
      let endDate = ganttViewEnd ? new Date(ganttViewEnd) : new Date(now);
      if(!ganttViewEnd) endDate.setDate(endDate.getDate() + 30);
      endDate.setHours(23, 59, 59, 999); // Normalize to end of day
      
      const days = [];
      for(let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)){
        const dayCopy = new Date(d);
        dayCopy.setHours(0, 0, 0, 0); // Ensure each day is at midnight
        days.push(dayCopy);
      }
      
      ganttTimeline.innerHTML = '';
      
      // Group days by month
      const monthGroups = {};
      days.forEach(day => {
        const monthKey = `${day.getFullYear()}-${day.getMonth()}`;
        if(!monthGroups[monthKey]) {
          monthGroups[monthKey] = {
            year: day.getFullYear(),
            month: day.getMonth(),
            days: []
          };
        }
        monthGroups[monthKey].days.push(day);
      });
      
      // Create header
      const header = document.createElement('div');
      header.className = 'gantt-header';
      
      Object.values(monthGroups).forEach(group => {
        const groupEl = document.createElement('div');
        groupEl.className = 'gantt-header-group';
        groupEl.style.width = `${(group.days.length / days.length) * 100}%`;
        
        const yearEl = document.createElement('div');
        yearEl.className = 'gantt-header-year';
        yearEl.textContent = group.year;
        groupEl.appendChild(yearEl);
        
        const monthEl = document.createElement('div');
        monthEl.className = 'gantt-header-month';
        const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
        monthEl.textContent = monthNames[group.month];
        groupEl.appendChild(monthEl);
        
        const daysRow = document.createElement('div');
        daysRow.style.display = 'flex';
        group.days.forEach(day => {
          const dayEl = document.createElement('div');
          dayEl.className = 'gantt-header-day';
          const dayNames = ['א','ב','ג','ד','ה','ו','ש'];
          // Normalize day to ensure consistent day-of-week calculation
          const normalizedDay = new Date(day);
          normalizedDay.setHours(12, 0, 0, 0); // Use noon to avoid timezone edge cases
          const dayName = dayNames[normalizedDay.getDay()];
          const nowNormalized = new Date(now);
          nowNormalized.setHours(0, 0, 0, 0);
          const dayNormalized = new Date(day);
          dayNormalized.setHours(0, 0, 0, 0);
          const isToday = dayNormalized.getTime() === nowNormalized.getTime();
          if(isToday) dayEl.classList.add('today');
          
          dayEl.innerHTML = `
            <div class="gantt-header-day-name">${dayName}</div>
            <div class="gantt-header-day-num">${day.getDate()}</div>
          `;
          daysRow.appendChild(dayEl);
        });
        groupEl.appendChild(daysRow);
        header.appendChild(groupEl);
      });
      
      ganttTimeline.appendChild(header);
      
      // Create tasks container first (needed for height calculation)
      const tasksContainer = document.createElement('div');
      tasksContainer.className = 'gantt-tasks-container';
      tasksContainer.style.height = `${allTasks.length * 48}px`;
      
      // Add separator lines (weeks, months, years) - positioned after header
      const totalDays = days.length;
      let prevYear = null;
      let prevMonth = null;
      let prevDayOfWeek = null;
      
      days.forEach((day, dayIdx) => {
        // Ensure day is normalized to midnight for consistent day-of-week calculation
        const normalizedDay = new Date(day);
        normalizedDay.setHours(12, 0, 0, 0); // Use noon to avoid timezone issues
        const currentDayOfWeek = normalizedDay.getDay(); // 0 = Sunday, 6 = Saturday
        
        const dayPercent = (dayIdx / totalDays) * 100;
        const isYearChange = prevYear !== null && normalizedDay.getFullYear() !== prevYear;
        const isMonthChange = prevMonth !== null && normalizedDay.getMonth() !== prevMonth;
        // Week separator: at the start of each week (Sunday = 0)
        const isWeekStart = currentDayOfWeek === 0 && dayIdx > 0; // Sunday, but not the first day
        
        if(isYearChange){
          const separator = document.createElement('div');
          separator.className = 'gantt-year-separator';
          separator.style.left = `${dayPercent}%`;
          ganttTimeline.appendChild(separator);
        } else if(isMonthChange){
          const separator = document.createElement('div');
          separator.className = 'gantt-month-separator';
          separator.style.left = `${dayPercent}%`;
          ganttTimeline.appendChild(separator);
        } else if(isWeekStart){
          const separator = document.createElement('div');
          separator.className = 'gantt-week-separator';
          separator.style.left = `${dayPercent}%`;
          ganttTimeline.appendChild(separator);
        }
        
        prevYear = normalizedDay.getFullYear();
        prevMonth = normalizedDay.getMonth();
        prevDayOfWeek = currentDayOfWeek;
      });
      
      // Add "today" vertical line
      const todayDate = new Date();
      todayDate.setHours(0, 0, 0, 0);
      const todayInRange = todayDate >= startDate && todayDate <= endDate;
      if(todayInRange){
        const todayIdx = days.findIndex(d => d.toDateString() === todayDate.toDateString());
        if(todayIdx >= 0){
          const todayPercent = ((todayIdx + 0.5) / totalDays) * 100; // Center of the day
          const todayLine = document.createElement('div');
          todayLine.className = 'gantt-today-line';
          todayLine.style.left = `${todayPercent}%`;
          ganttTimeline.appendChild(todayLine);
        }
      }
      
      allTasks.forEach((task, idx) => {
        const start = new Date(task.startDate.seconds * 1000);
        start.setHours(0, 0, 0, 0); // Normalize to start of day
        const end = new Date(task.endDate.seconds * 1000);
        end.setHours(0, 0, 0, 0); // Normalize to start of day for consistent comparison
        const overdue = isTaskOverdue(task);
        
        // Use the actual days array length for accurate calculation (avoids rounding errors)
        const totalDays = days.length;
        
        // Calculate task position relative to the view start date
        const taskStartDays = Math.max(0, Math.floor((start.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)));
        const taskEndDays = Math.min(totalDays, Math.ceil((end.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1);
        const taskDuration = Math.max(1, taskEndDays - taskStartDays);
        
        const leftPercent = (taskStartDays / totalDays) * 100;
        const widthPercent = (taskDuration / totalDays) * 100;
        
        const taskEl = document.createElement('div');
        taskEl.className = 'gantt-task';
        taskEl.setAttribute('data-task-id', task.id);
        taskEl.style.left = `${leftPercent}%`;
        taskEl.style.width = `${widthPercent}%`;
        taskEl.style.top = `${idx * 48}px`;
        
        const taskColor = getTaskColor(task);
        taskEl.style.backgroundColor = taskColor;
        taskEl.style.color = '#fff';
        if(overdue && task.status !== 'finished' && task.status !== 'canceled'){
          taskEl.style.borderColor = '#dc2626';
          taskEl.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.3)';
        }
        
        const taskText = task.name || 'ללא שם';
        const statusIcon = overdue ? '⚠️ ' : task.status === 'finished' ? '✓ ' : task.status === 'in_progress' ? '▶ ' : '';
        taskEl.textContent = statusIcon + taskText;
        
        const resp = task.responsibility ? ` (${task.responsibility === 'Hadar' ? 'הדר' : 'גיל'})` : '';
        const statusText = task.status === 'finished' ? ' - הושלם' : task.status === 'in_progress' ? ' - בתהליך' : task.status === 'canceled' ? ' - בוטל' : '';
        taskEl.title = `${task.name}${resp}${statusText}\n${start.toLocaleDateString('he-IL')} - ${end.toLocaleDateString('he-IL')}${overdue ? '\n⚠️ חריג!' : ''}`;
        taskEl.addEventListener('click', ()=> openTaskEditor(task));
        
        tasksContainer.appendChild(taskEl);
      });
      
      ganttTimeline.appendChild(tasksContainer);
    }
    */
    
    // Use module version of renderGantt if available
    function renderGantt(){
      if(typeof window !== 'undefined' && window.renderGantt){
        window.renderGantt();
      } else {
        console.warn('renderGantt module not loaded');
      }
    }
    
    // OLD Gantt navigation functions - COMMENTED OUT, using module versions from tasks.js
    /*
    function saveGanttViewState(){
      try{
        if(ganttViewStart) localStorage.setItem(GANTT_VIEW_START_KEY, ganttViewStart.getTime().toString());
        if(ganttViewEnd) localStorage.setItem(GANTT_VIEW_END_KEY, ganttViewEnd.getTime().toString());
      }catch(_){}
    }
    
    function loadGanttViewState(){
      try{
        const savedStart = localStorage.getItem(GANTT_VIEW_START_KEY);
        const savedEnd = localStorage.getItem(GANTT_VIEW_END_KEY);
        if(savedStart) ganttViewStart = new Date(parseInt(savedStart));
        if(savedEnd) ganttViewEnd = new Date(parseInt(savedEnd));
      }catch(_){}
    }
    
    function ganttJumpToToday(){
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      ganttViewStart = new Date(now);
      ganttViewStart.setDate(ganttViewStart.getDate() - 7);
      ganttViewEnd = new Date(now);
      ganttViewEnd.setDate(ganttViewEnd.getDate() + 30);
      saveGanttViewState();
      renderGantt();
      // Scroll to today line after a brief delay to allow rendering
      setTimeout(() => {
        const ganttContainer = document.getElementById('ganttContainer');
        if(ganttContainer){
          const todayLine = ganttContainer.querySelector('.gantt-today-line');
          if(todayLine){
            const lineLeft = todayLine.offsetLeft;
            ganttContainer.scrollLeft = lineLeft - (ganttContainer.clientWidth / 2);
          }
        }
      }, 100);
    }
    
    function ganttJumpToDate(){
      const dateStr = prompt('הזן תאריך (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
      if(!dateStr) return;
      const targetDate = new Date(dateStr + 'T00:00:00');
      if(isNaN(targetDate.getTime())){
        toast('תאריך לא תקין');
        return;
      }
      ganttViewStart = new Date(targetDate);
      ganttViewStart.setDate(ganttViewStart.getDate() - 7);
      ganttViewEnd = new Date(targetDate);
      ganttViewEnd.setDate(ganttViewEnd.getDate() + 30);
      saveGanttViewState();
      renderGantt();
    }
    
    function ganttNavigate(direction){
      if(!ganttViewStart || !ganttViewEnd){
        // Initialize view if not set
        const now = new Date();
        ganttViewStart = new Date(now);
        ganttViewStart.setDate(ganttViewStart.getDate() - 7);
        ganttViewEnd = new Date(now);
        ganttViewEnd.setDate(ganttViewEnd.getDate() + 30);
      }
      
      const shiftDays = direction === 'prev' ? -7 : 7;
      
      ganttViewStart.setDate(ganttViewStart.getDate() + shiftDays);
      ganttViewEnd.setDate(ganttViewEnd.getDate() + shiftDays);
      saveGanttViewState();
      renderGantt();
    }
    
    // Gantt navigation event listeners
    if(ganttToday){
      ganttToday.addEventListener('click', ganttJumpToToday);
    }
    if(ganttJumpTo){
      ganttJumpTo.addEventListener('click', ganttJumpToDate);
    }
    if(ganttPrev){
      ganttPrev.addEventListener('click', ()=> ganttNavigate('prev'));
    }
    if(ganttNext){
      ganttNext.addEventListener('click', ()=> ganttNavigate('next'));
    }
    
    // Task navigation functions
    function ganttJumpToTask(direction){
      const allTasks = Object.values(TASKS).flat().filter(t => t.startDate && t.endDate);
      if(allTasks.length === 0){
        toast('אין משימות עם תאריכים');
        return;
      }
      
      // Sort tasks by start date
      allTasks.sort((a, b) => {
        const dateA = a.startDate.seconds || 0;
        const dateB = b.startDate.seconds || 0;
        return dateA - dateB;
      });
      
      const now = new Date();
      const nowSeconds = Math.floor(now.getTime() / 1000);
      
      // Find current task (task that includes today or next upcoming task)
      let targetTask = null;
      if(direction === 'next'){
        // Find next task after today
        targetTask = allTasks.find(t => {
          const startSeconds = t.startDate?.seconds || 0;
          return startSeconds > nowSeconds;
        });
        if(!targetTask) targetTask = allTasks[0]; // Wrap to first if none found
      } else {
        // Find previous task before today
        const tasksBefore = allTasks.filter(t => {
          const startSeconds = t.startDate?.seconds || 0;
          return startSeconds < nowSeconds;
        });
        targetTask = tasksBefore.length > 0 ? tasksBefore[tasksBefore.length - 1] : allTasks[allTasks.length - 1]; // Wrap to last if none found
      }
      
      if(!targetTask || !targetTask.startDate) return;
      
      const taskStart = new Date(targetTask.startDate.seconds * 1000);
      taskStart.setHours(0, 0, 0, 0);
      
      // Set view to show the task
      ganttViewStart = new Date(taskStart);
      ganttViewStart.setDate(ganttViewStart.getDate() - 7);
      ganttViewEnd = new Date(taskStart);
      ganttViewEnd.setDate(ganttViewEnd.getDate() + 30);
      saveGanttViewState();
      renderGantt();
      
      // Scroll to task after rendering
      setTimeout(() => {
        const ganttContainer = document.getElementById('ganttContainer');
        if(ganttContainer){
          const taskEl = ganttContainer.querySelector(`[data-task-id="${targetTask.id}"]`);
          if(taskEl){
            const taskLeft = taskEl.offsetLeft;
            ganttContainer.scrollLeft = taskLeft - (ganttContainer.clientWidth / 2);
          }
        }
      }, 100);
    }
    
    */
    // All navigation functions now handled by tasks.js module
    // Old inline versions above are commented out to prevent conflicts
    
    
    function openTaskCategoryEditor(mode='create', catId=null){
      const taskCatModal = document.getElementById('taskCatModal');
      const taskCatIdEl = document.getElementById('taskCatId');
      const taskCatName = document.getElementById('taskCatName');
      const taskCatPreview = document.getElementById('taskCatPreview');
      const taskCatPinned = document.getElementById('taskCatPinned');
      const taskCatFile = document.getElementById('taskCatFile');
      const taskCatFileName = document.getElementById('taskCatFileName');
      const taskCatColor = document.getElementById('taskCatColor');
      const taskCatDelete = document.getElementById('taskCatDelete');
      const taskCatModalTitle = document.getElementById('taskCatModalTitle');
      
      if(!taskCatModal || !taskCatIdEl || !taskCatName) {
        console.error('Task category modal elements not found');
        return;
      }
      
      taskCatIdEl.value = catId||'';
      taskCatName.value=''; 
      taskCatPreview.src='/cat.png';
      taskCatPinned.checked = false;
      taskCatFile.value=''; 
      taskCatFileName.textContent='לא נבחרה תמונה';
      taskCatColor.value='#3b82f6';
      taskCatDelete.classList.toggle('hidden', mode!=='edit');
      taskCatModalTitle.textContent = (mode==='edit') ? 'עריכת קטגוריית משימות' : 'קטגוריית משימות חדשה';
      
      // Reset color selection
      document.querySelectorAll('#taskCatModal .color-option').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-offset-2');
        btn.style.borderColor = 'var(--border)';
      });
      const defaultColorBtn = document.querySelector(`#taskCatModal .color-option[data-color="#3b82f6"]`);
      if(defaultColorBtn){
        defaultColorBtn.classList.add('ring-2', 'ring-offset-2');
        defaultColorBtn.style.borderColor = '#3b82f6';
      }
      
      if(mode==='edit' && catId){
        const c=TASK_CATEGORIES.find(x=>x.id===catId);
        if(c){
          taskCatName.value=c.label||'';
          taskCatPreview.src=c.img||'/cat.png';
          taskCatPinned.checked = !!c.pinned;
          taskCatColor.value = c.color||'#3b82f6';
          
          // Select the color button
          document.querySelectorAll('#taskCatModal .color-option').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-offset-2');
            btn.style.borderColor = 'var(--border)';
            if(btn.dataset.color === taskCatColor.value){
              btn.classList.add('ring-2', 'ring-offset-2');
              btn.style.borderColor = taskCatColor.value;
            }
          });
        }
      }
      taskCatModal.classList.add('show');
    }
    
    // OLD INLINE CODE - NOW HANDLED BY TASKS MODULE
    // Task category save/delete handlers are in tasks.js module
    
    function openTaskEditor(task, catId = null){
      if(task){
        teId.value = task.id;
        teName.value = task.name || '';
        if(task.startDate){
          const start = new Date(task.startDate.seconds * 1000);
          teStartDate.value = start.toISOString().slice(0,10);
        } else {
          teStartDate.value = '';
        }
        if(task.endDate){
          const end = new Date(task.endDate.seconds * 1000);
          teEndDate.value = end.toISOString().slice(0,10);
        } else {
          teEndDate.value = '';
        }
        teResponsibility.value = task.responsibility || '';
        teStatus.value = task.status || 'todo';
        teDetails.value = task.details || '';
        teDelete.classList.remove('hidden');
      } else {
        teId.value = '';
        teName.value = '';
        teStartDate.value = '';
        teEndDate.value = '';
        teResponsibility.value = '';
        teStatus.value = 'todo';
        teDetails.value = '';
        teDelete.classList.add('hidden');
      }
      
      // Populate category select
      teCategory.innerHTML = '';
      for(const c of TASK_CATEGORIES){
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.label || '';
        if((task?.category || catId || selectedTaskCategory) === c.id) opt.selected = true;
        teCategory.appendChild(opt);
      }
      
      taskEditModal.classList.add('show');
    }
    
    document.querySelectorAll('#taskEditModal [data-close]').forEach(el=> el.addEventListener('click',()=> taskEditModal.classList.remove('show')));
    
    teSave.addEventListener('click', async ()=>{
      const name = (teName.value||'').trim();
      if(!name){ toast('צריך שם משימה'); return; }
      
      const startDateStr = teStartDate.value;
      const endDateStr = teEndDate.value;
      const categoryId = teCategory.value || catId || selectedTaskCategory;
      
      if(!categoryId){
        toast('בחר קטגוריה');
        return;
      }
      
      showLoading('שומר משימה...');
      try{
        const taskData = {
          name,
          category: categoryId,
          responsibility: teResponsibility.value || null,
          status: teStatus.value || 'todo',
          details: (teDetails.value||'').trim() || null,
          updatedAt: serverTimestamp()
        };
        
        // Add dates only if provided
        if(startDateStr){
          const startDate = new Date(startDateStr + 'T00:00:00');
          if(!isNaN(startDate.getTime())){
            taskData.startDate = Timestamp.fromDate(startDate);
          }
        }
        
        if(endDateStr){
          const endDate = new Date(endDateStr + 'T23:59:59');
          if(!isNaN(endDate.getTime())){
            taskData.endDate = Timestamp.fromDate(endDate);
          }
        }
        
        if(teId.value){
          await updateDoc(doc(householdRef,'tasks', teId.value), taskData);
          toast('משימה עודכנה');
        } else {
          taskData.createdAt = serverTimestamp();
          await addDoc(tasksCol, taskData);
          toast('משימה נוספה');
        }
        taskEditModal.classList.remove('show');
      }catch(e){
        console.error('Task save error:', e);
        const errorMsg = e.message || e.code || 'נסה שוב';
        toast('שגיאה בשמירת משימה: ' + errorMsg, 4000);
      }
      finally{
        hideLoading();
      }
    });
    
    teDelete.addEventListener('click', async ()=>{
      const id = teId.value;
      if(!id) return;
      if(!confirm('למחוק את המשימה?')) return;
      showLoading('מוחק משימה...');
      try{
        await deleteDoc(doc(householdRef,'tasks', id));
        taskEditModal.classList.remove('show');
        toast('משימה נמחקה');
      }catch(e){
        console.error(e);
        toast('שגיאה במחיקה', 3000);
      }
      finally{
        hideLoading();
      }
    });

    // CRITICAL: Ensure app content is visible after initialization
    console.log('App initialization complete - showing app content');
    showApp();

    } // End of startApp() function

    /* ---------------- Close modals via [data-close] ---------------- */
    document.querySelectorAll('.modal [data-close]').forEach(el=> el.addEventListener('click', (e)=> e.target.closest('.modal')?.classList.remove('show')));

  </script>
</body>
</html>
