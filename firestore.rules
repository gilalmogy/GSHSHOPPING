rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user ID
    function getUserId() {
      return request.auth.uid;
    }
    
    // Helper function to get household data (cached per rule evaluation)
    function getHouseholdData(householdId) {
      return get(/databases/$(database)/documents/households/$(householdId)).data;
    }
    
    // Helper function to check if user is owner OR member of a household
    // Uses cached household data to avoid multiple reads
    function isHouseholdOwnerOrMember(householdId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/households/$(householdId)) &&
             (
               getHouseholdData(householdId).ownerId == getUserId() ||
               (getHouseholdData(householdId).members != null && getUserId() in getHouseholdData(householdId).members)
             );
    }
    
    // Helper function to check if user is owner of a household
    function isHouseholdOwner(householdId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/households/$(householdId)) &&
             get(/databases/$(database)/documents/households/$(householdId)).data.ownerId == getUserId();
    }
    
    // Users collection - users can read their own profile and update their own profile
    match /users/{userId} {
      allow read: if isAuthenticated() && userId == getUserId();
      allow create: if isAuthenticated() && userId == getUserId();
      allow update: if isAuthenticated() && userId == getUserId();
      allow delete: if false; // Users cannot delete their own profile
      
      // FCM Tokens subcollection (for push notifications)
      match /fcmTokens/{tokenId} {
        allow read, write: if isAuthenticated() && userId == getUserId();
      }
    }
    
    // Households collection - only members can read, only owner can update
    match /households/{householdId} {
      // Allow list queries for authenticated users (needed for household queries)
      allow list: if isAuthenticated();
      // Allow read individual document if user is a member or owner
      allow get: if isHouseholdOwnerOrMember(householdId);
      // Allow create if authenticated user is setting themselves as owner and member
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == getUserId() &&
                       request.resource.data.members != null &&
                       getUserId() in request.resource.data.members;
      // Allow update if user is owner, or if updating members (for joining)
      allow update: if isAuthenticated() && (
        isHouseholdOwner(householdId) ||
        (resource.data.members != null && getUserId() in resource.data.members && request.resource.data.members != null && getUserId() in request.resource.data.members)
      );
      allow delete: if false; // Households cannot be deleted for data safety
      
      // Household subcollections - allow if user is owner or member
      
      // Categories (shopping)
      match /categories/{categoryId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Items (shopping)
      match /items/{itemId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Task Categories
      match /taskCategories/{categoryId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Tasks
      match /tasks/{taskId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Note Categories
      match /noteCategories/{categoryId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Notes
      match /notes/{noteId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Reminder Categories
      match /reminderCategories/{categoryId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Reminders
      match /reminders/{reminderId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // Purchase Events (for analytics)
      match /purchaseEvents/{eventId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
      
      // FCM Tokens (for push notifications)
      match /fcmTokens/{tokenId} {
        allow read, write: if isHouseholdOwnerOrMember(householdId);
      }
    }
    
    // Household invites collection - allow authenticated users to read/create invites
    match /householdInvites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated(); // Allow updating to mark as used
      allow delete: if false;
    }
  }
}
